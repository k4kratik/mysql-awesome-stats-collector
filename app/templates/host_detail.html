{% extends "base.html" %}

{# Info tooltip macro - hover to show definition #}
{% macro info_tooltip(text, position='right') %}
<div class="relative inline-flex ml-1.5 group">
    <svg class="w-4 h-4 text-midnight-500 hover:text-ocean-400 cursor-help transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div class="absolute z-50 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 
                {% if position == 'left' %}right-full mr-2{% elif position == 'bottom' %}top-full mt-2 left-1/2 -translate-x-1/2{% else %}left-full ml-2{% endif %}
                w-64 p-3 text-xs text-midnight-200 bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl shadow-black/30">
        <div class="font-normal leading-relaxed">{{ text }}</div>
        <div class="absolute {% if position == 'left' %}right-0 top-1/2 -translate-y-1/2 translate-x-1{% elif position == 'bottom' %}bottom-full left-1/2 -translate-x-1/2 translate-y-1{% else %}left-0 top-1/2 -translate-y-1/2 -translate-x-1{% endif %} 
                    w-2 h-2 bg-midnight-900 border-midnight-700 
                    {% if position == 'left' %}border-r border-t rotate-45{% elif position == 'bottom' %}border-t border-l rotate-45{% else %}border-l border-b rotate-45{% endif %}"></div>
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm flex-wrap">
        <a href="/jobs" class="text-midnight-400 hover:text-white transition-colors">Jobs</a>
        <svg class="w-4 h-4 text-midnight-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/jobs/{{ job.id }}" class="text-midnight-400 hover:text-white transition-colors">
            {% if job.name %}
            <span>{{ job.name }}</span>
            <span class="text-midnight-600 mx-1">‚Ä¢</span>
            <span class="font-mono text-midnight-500">{{ job.id[:8] }}...</span>
            {% else %}
            <span class="font-mono">{{ job.id[:8] }}...</span>
            {% endif %}
        </a>
        <svg class="w-4 h-4 text-midnight-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <!-- Host selector dropdown -->
        <div class="relative" x-data="{ open: false }">
            <button 
                @click="open = !open"
                @click.outside="open = false"
                class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-midnight-800/50 border border-midnight-700 hover:border-ocean-500/50 hover:bg-midnight-700/50 text-white transition-all"
            >
                <span>{{ host_label }}</span>
                <svg class="w-4 h-4 text-midnight-400 transition-transform" :class="open && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            
            <!-- Dropdown menu -->
            <div 
                x-show="open"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                class="absolute left-0 mt-2 w-64 rounded-xl bg-midnight-800 border border-midnight-700 shadow-xl shadow-black/30 z-50 overflow-hidden"
            >
                <div class="py-1 max-h-80 overflow-y-auto">
                    {% for h in job_hosts_list %}
                    <a 
                        href="/jobs/{{ job.id }}/hosts/{{ h.host_id }}?tab={{ tab }}"
                        class="flex items-center gap-3 px-4 py-2.5 hover:bg-midnight-700/50 transition-colors {% if h.host_id == host_id %}bg-ocean-500/10 border-l-2 border-ocean-500{% endif %}"
                    >
                        <!-- Status indicator -->
                        <span class="flex-shrink-0">
                            {% if h.status == 'completed' %}
                            <span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>
                            {% elif h.status == 'failed' %}
                            <span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span>
                            {% elif h.status == 'running' %}
                            <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse inline-block"></span>
                            {% else %}
                            <span class="w-2 h-2 rounded-full bg-midnight-500 inline-block"></span>
                            {% endif %}
                        </span>
                        <span class="{% if h.host_id == host_id %}text-ocean-400 font-medium{% else %}text-midnight-200{% endif %}">
                            {{ h.label }}
                        </span>
                        {% if h.host_id == host_id %}
                        <svg class="w-4 h-4 text-ocean-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="glass-card glow-border rounded-2xl p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-ocean-400 to-ocean-600 flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                        {{ host_label }}
                        {% if replica_status and replica_status.is_replica %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold
                            {% if replica_status.seconds_behind_master is none %}
                                bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                            {% elif replica_status.seconds_behind_master == 0 %}
                                bg-volt-500/20 text-volt-400 border border-volt-500/30
                            {% elif replica_status.seconds_behind_master < 10 %}
                                bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                            {% else %}
                                bg-crimson-500/20 text-crimson-400 border border-crimson-500/30
                            {% endif %}
                            ">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Replica
                            {% if replica_status.seconds_behind_master is none %}
                            (NULL lag)
                            {% elif replica_status.seconds_behind_master == 0 %}
                            (0s lag)
                            {% else %}
                            ({{ replica_status.seconds_behind_master }}s lag)
                            {% endif %}
                        </span>
                        {% endif %}
                    </h1>
                    <p class="text-midnight-400 font-mono text-sm">Host ID: {{ host_id }}</p>
                </div>
            </div>
            <div class="flex items-center gap-16">
                <!-- Server Uptime -->
                {% if global_status and global_status.Uptime %}
                <div class="text-right">
                    <p class="text-xs text-midnight-500">Server Uptime</p>
                    <p class="text-sm text-ocean-400 font-mono" title="{{ global_status.Uptime }} seconds">
                        {{ global_status.Uptime | format_uptime }}
                    </p>
                </div>
                {% endif %}
                
                <!-- Collection Time -->
            {% if job_host.completed_at %}
            <div class="text-right">
                <p class="text-xs text-midnight-500">Collected</p>
                <p class="text-sm text-midnight-300 font-mono">{{ job_host.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                {% if timing_data and timing_data.total_duration %}
                <p class="text-xs text-volt-400 font-medium">‚ö° {{ timing_data.total_duration }}s (parallel)</p>
                {% elif job_host.started_at %}
                <p class="text-xs text-midnight-500">Duration: {{ ((job_host.completed_at - job_host.started_at).total_seconds())|round(1) }}s</p>
                {% endif %}
            </div>
            {% endif %}
            </div>
            
            <!-- Timing Breakdown (if available) -->
            {% if timing_data and timing_data.commands %}
            <div class="ml-4 pl-4 border-l border-midnight-700/50" x-data="{ showTiming: false }">
                <button @click="showTiming = !showTiming" class="text-xs text-midnight-400 hover:text-white flex items-center gap-1">
                    <svg class="w-3 h-3 transition-transform" :class="showTiming ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    Command Timing
                </button>
                <div x-show="showTiming" x-cloak class="mt-2 text-xs space-y-1">
                    {% for cmd, info in timing_data.commands.items() %}
                    <div class="flex items-center gap-2">
                        {% if info.success %}
                        <span class="text-green-400">‚úì</span>
                        {% else %}
                        <span class="text-red-400">‚úó</span>
                        {% endif %}
                        <span class="text-midnight-400 truncate max-w-[200px]" title="{{ cmd }}">
                            {%- if 'INNODB' in cmd -%}InnoDB Status
                            {%- elif 'PROCESSLIST' in cmd -%}Processlist
                            {%- elif 'VARIABLES' in cmd -%}Variables
                            {%- elif 'SLAVE STATUS' in cmd or 'REPLICA STATUS' in cmd -%}Replica Status
                            {%- elif 'MASTER STATUS' in cmd -%}Master Status
                            {%- elif 'STATUS' in cmd -%}Global Status
                            {%- else -%}{{ cmd }}
                            {%- endif -%}
                        </span>
                        <span class="text-midnight-300 font-mono">{{ info.duration }}s</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Replication Status (if replica) -->
    {% if replica_status and replica_status.is_replica %}
    <div class="glass-card rounded-2xl p-4 border 
        {% if replica_status.seconds_behind_master is none %}
            border-yellow-500/30 bg-yellow-500/5
        {% elif replica_status.seconds_behind_master == 0 %}
            border-volt-500/30 bg-volt-500/5
        {% elif replica_status.seconds_behind_master < 10 %}
            border-yellow-500/30 bg-yellow-500/5
        {% else %}
            border-crimson-500/30 bg-crimson-500/5
        {% endif %}
        ">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center
                    {% if replica_status.seconds_behind_master is none %}
                        bg-yellow-500/20
                    {% elif replica_status.seconds_behind_master == 0 %}
                        bg-volt-500/20
                    {% elif replica_status.seconds_behind_master < 10 %}
                        bg-yellow-500/20
                    {% else %}
                        bg-crimson-500/20
                    {% endif %}
                    ">
                    <svg class="w-5 h-5 
                        {% if replica_status.seconds_behind_master is none %}
                            text-yellow-400
                        {% elif replica_status.seconds_behind_master == 0 %}
                            text-volt-400
                        {% elif replica_status.seconds_behind_master < 10 %}
                            text-yellow-400
                        {% else %}
                            text-crimson-400
                        {% endif %}
                        " fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-white">Replication Status</h3>
                    <p class="text-xs text-midnight-400">
                        Replicating from {{ replica_status.master_host }}{% if replica_status.master_port %}:{{ replica_status.master_port }}{% endif %}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <!-- Lag -->
                <div class="text-center">
                    <p class="text-2xl font-bold font-mono
                        {% if replica_status.seconds_behind_master is none %}
                            text-yellow-400
                        {% elif replica_status.seconds_behind_master == 0 %}
                            text-volt-400
                        {% elif replica_status.seconds_behind_master < 10 %}
                            text-yellow-400
                        {% else %}
                            text-crimson-400
                        {% endif %}
                        ">
                        {% if replica_status.seconds_behind_master is none %}
                        NULL
                        {% else %}
                        {{ replica_status.seconds_behind_master }}s
                        {% endif %}
                    </p>
                    <p class="text-[10px] text-midnight-500 uppercase tracking-wider">Lag</p>
                </div>
                <!-- IO Thread -->
                <div class="text-center">
                    <p class="text-sm font-medium {{ 'text-volt-400' if replica_status.slave_io_running == 'Yes' else 'text-crimson-400' }}">
                        {{ replica_status.slave_io_running or 'N/A' }}
                    </p>
                    <p class="text-[10px] text-midnight-500 uppercase tracking-wider">IO Thread</p>
                </div>
                <!-- SQL Thread -->
                <div class="text-center">
                    <p class="text-sm font-medium {{ 'text-volt-400' if replica_status.slave_sql_running == 'Yes' else 'text-crimson-400' }}">
                        {{ replica_status.slave_sql_running or 'N/A' }}
                    </p>
                    <p class="text-[10px] text-midnight-500 uppercase tracking-wider">SQL Thread</p>
                </div>
            </div>
        </div>
        {% if replica_status.last_error %}
        <div class="mt-3 p-2 rounded-lg bg-crimson-500/10 border border-crimson-500/30">
            <p class="text-xs text-crimson-400">
                <span class="font-semibold">Error {{ replica_status.last_errno }}:</span> {{ replica_status.last_error }}
            </p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Buffer Pool Summary Card -->
    {% if buffer_pool and buffer_pool.pool_size_gb %}
    <div class="glass-card rounded-2xl p-5 border border-midnight-700/50">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-ocean-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </div>
                <div class="flex items-center gap-2">
                    <div>
                        <h3 class="text-white font-semibold">InnoDB Buffer Pool</h3>
                        <p class="text-xs text-midnight-400">Memory allocation and efficiency</p>
                    </div>
                    {{ info_tooltip("The buffer pool is InnoDB's main memory cache for data and indexes. Proper sizing (typically 70-80% of available RAM) is critical for performance. This summary shows key health indicators.", 'bottom') }}
                </div>
            </div>
            <!-- Health Badge -->
            <span class="px-3 py-1 rounded-full text-xs font-medium
                {% if buffer_pool.health == 'healthy' %}
                    bg-volt-500/20 text-volt-400 border border-volt-500/30
                {% elif buffer_pool.health == 'mild' %}
                    bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                {% else %}
                    bg-crimson-500/20 text-crimson-400 border border-crimson-500/30
                {% endif %}
            ">
                {% if buffer_pool.health == 'healthy' %}üü¢ Healthy
                {% elif buffer_pool.health == 'mild' %}üü° Mild Pressure
                {% else %}üî¥ Memory Pressure
                {% endif %}
            </span>
        </div>
        
        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <!-- Buffer Pool Size -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Pool Size</p>
                <p class="text-lg font-mono text-white">{{ buffer_pool.pool_size_gb }}<span class="text-sm text-midnight-400">GB</span></p>
            </div>
            
            <!-- Used -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Used</p>
                <p class="text-lg font-mono text-white">{{ buffer_pool.used_gb }}<span class="text-sm text-midnight-400">GB</span></p>
                {% if buffer_pool.used_percent is not none %}
                <p class="text-xs text-midnight-500">({{ buffer_pool.used_percent }}%)</p>
                {% endif %}
            </div>
            
            <!-- Free -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Free</p>
                <p class="text-lg font-mono text-white">{{ buffer_pool.free_gb }}<span class="text-sm text-midnight-400">GB</span></p>
                {% if buffer_pool.free_percent is not none %}
                <p class="text-xs text-midnight-500">({{ buffer_pool.free_percent }}%)</p>
                {% endif %}
            </div>
            
            <!-- Dirty Pages -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Dirty Pages</p>
                <p class="text-lg font-mono 
                    {% if buffer_pool.dirty_percent and buffer_pool.dirty_percent > 50 %}text-yellow-400{% else %}text-white{% endif %}
                ">{{ buffer_pool.dirty_percent if buffer_pool.dirty_percent is not none else '-' }}<span class="text-sm text-midnight-400">%</span></p>
            </div>
            
            <!-- Hit Ratio -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Hit Ratio</p>
                <p class="text-lg font-mono 
                    {% if buffer_pool.hit_ratio and buffer_pool.hit_ratio >= 99 %}text-volt-400
                    {% elif buffer_pool.hit_ratio and buffer_pool.hit_ratio >= 97 %}text-yellow-400
                    {% elif buffer_pool.hit_ratio %}text-crimson-400
                    {% else %}text-white{% endif %}
                ">{{ buffer_pool.hit_ratio if buffer_pool.hit_ratio is not none else '-' }}<span class="text-sm text-midnight-400">%</span></p>
            </div>
            
            <!-- Wait Free -->
            <div class="p-3 rounded-lg bg-midnight-800/50">
                <p class="text-xs text-midnight-400 mb-1">Wait Free</p>
                <p class="text-lg font-mono 
                    {% if buffer_pool.wait_free and buffer_pool.wait_free > 0 %}text-crimson-400{% else %}text-volt-400{% endif %}
                ">{{ buffer_pool.wait_free if buffer_pool.wait_free is not none else '0' }}</p>
            </div>
        </div>
        
        {% if buffer_pool.health_reason %}
        <p class="mt-3 text-xs text-midnight-500 italic">{{ buffer_pool.health_reason }}</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Hot Tables (optional - only shown if collected) -->
    {# Macro for formatting large numbers with K/M/B suffixes #}
    {% macro format_ops(num) %}
        {%- if num >= 1000000000 -%}
            {{ "%.1f"|format(num / 1000000000) }}B
        {%- elif num >= 1000000 -%}
            {{ "%.1f"|format(num / 1000000) }}M
        {%- elif num >= 1000 -%}
            {{ "%.1f"|format(num / 1000) }}K
        {%- else -%}
            {{ num }}
        {%- endif -%}
    {% endmacro %}
    
    {% if hot_tables and hot_tables.tables %}
    <div class="glass-card rounded-2xl p-5 border border-midnight-700/50" x-data="hotTablesSort()">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
                    </svg>
                </div>
                <div class="flex items-center gap-2">
                    <div>
                        <h3 class="text-white font-semibold">Hot Tables</h3>
                        <p class="text-xs text-midnight-400">Most active tables by I/O operations (top 10)</p>
                    </div>
                    {{ info_tooltip("Data from performance_schema.table_io_waits_summary_by_index_usage. Shows tables with highest I/O activity since server start. 'Ops/sec' is calculated from total operations divided by server uptime. Enable 'Collect Hot Tables' option during collection.", 'bottom') }}
                </div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-medium bg-amber-500/20 text-amber-400 border border-amber-500/30">
                {{ hot_tables.tables|length }} tables
            </span>
        </div>
        
        <!-- Hot Tables Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-midnight-700/50">
                        <th @click="sort('schema')" class="px-3 py-2 text-left text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center gap-1">
                                Schema
                                <template x-if="sortCol === 'schema'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                        <th @click="sort('table')" class="px-3 py-2 text-left text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center gap-1">
                                Table
                                <template x-if="sortCol === 'table'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                        <th @click="sort('read_ops')" class="px-3 py-2 text-right text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end gap-1">
                                Reads
                                <template x-if="sortCol === 'read_ops'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                        <th @click="sort('write_ops')" class="px-3 py-2 text-right text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end gap-1">
                                Writes
                                <template x-if="sortCol === 'write_ops'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                        <th @click="sort('total_ops')" class="px-3 py-2 text-right text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end gap-1">
                                Total Ops
                                <template x-if="sortCol === 'total_ops'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                        <th @click="sort('ops_per_sec')" class="px-3 py-2 text-right text-xs font-semibold text-midnight-400 uppercase cursor-pointer hover:text-white transition-colors" x-show="uptime > 0" x-cloak>
                            <span class="flex items-center justify-end gap-1">
                                Ops/sec
                                <!-- Info icon with native title tooltip -->
                                <svg class="w-3.5 h-3.5 text-midnight-500 hover:text-ocean-400 cursor-help" 
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     @click.stop
                                     title="Average Ops/sec: Calculated as total_ops √∑ server_uptime. This is the average over the entire server uptime, not real-time. Use Compare to see delta between snapshots.">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <template x-if="sortCol === 'ops_per_sec'">
                                    <svg class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </template>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="t in sortedTables" :key="t.schema + '.' + t.table">
                        <tr class="border-b border-midnight-800/50 hover:bg-midnight-800/30">
                            <td class="px-3 py-2 font-mono text-midnight-300" x-text="t.schema"></td>
                            <td class="px-3 py-2 font-mono text-white" x-text="t.table"></td>
                            <td class="px-3 py-2 text-right font-mono text-ocean-400" :title="t.read_ops.toLocaleString()" x-text="formatNum(t.read_ops)"></td>
                            <td class="px-3 py-2 text-right font-mono text-amber-400" :title="t.write_ops.toLocaleString()" x-text="formatNum(t.write_ops)"></td>
                            <td class="px-3 py-2 text-right font-mono text-white font-semibold" :title="t.total_ops.toLocaleString()" x-text="formatNum(t.total_ops)"></td>
                            <td class="px-3 py-2 text-right font-mono text-volt-400" x-show="uptime > 0" x-cloak :title="(t.total_ops / uptime).toFixed(2) + ' ops/sec'" x-text="formatNum(Math.round(t.total_ops / uptime))"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <p class="mt-3 text-xs text-midnight-500">
            Hot tables indicate access frequency, not buffer pool size. Data from performance_schema. Click column headers to sort.
        </p>
        <p class="mt-2 text-sm text-midnight-400" x-show="uptime > 0" x-cloak>
            <span class="text-ocean-400 font-medium">‚ÑπÔ∏è Ops/sec</span> = total_ops √∑ server_uptime <span class="text-midnight-500">(average since server start, not real-time)</span>
        </p>
    </div>
    <script>
        window.hotTablesData = {{ hot_tables.tables | tojson | safe }};
        window.serverUptime = {{ global_status.Uptime | default(0) | int }};
        function hotTablesSort() {
            return {
                sortCol: 'total_ops',
                sortAsc: false,
                tables: window.hotTablesData || [],
                uptime: window.serverUptime || 0,
                get sortedTables() {
                    const uptime = this.uptime;
                    return [...this.tables].sort((a, b) => {
                        let aVal, bVal;
                        
                        if (this.sortCol === 'ops_per_sec') {
                            // Calculate ops/sec for sorting
                            aVal = uptime > 0 ? a.total_ops / uptime : 0;
                            bVal = uptime > 0 ? b.total_ops / uptime : 0;
                        } else {
                            aVal = a[this.sortCol];
                            bVal = b[this.sortCol];
                        }
                        
                        // String comparison for schema/table
                        if (this.sortCol === 'schema' || this.sortCol === 'table') {
                            aVal = String(aVal).toLowerCase();
                            bVal = String(bVal).toLowerCase();
                        }
                        
                        if (aVal < bVal) return this.sortAsc ? -1 : 1;
                        if (aVal > bVal) return this.sortAsc ? 1 : -1;
                        return 0;
                    });
                },
                sort(col) {
                    if (this.sortCol === col) {
                        this.sortAsc = !this.sortAsc;
                    } else {
                        this.sortCol = col;
                        this.sortAsc = col === 'schema' || col === 'table'; // Ascending for text, descending for numbers
                    }
                },
                formatNum(val) {
                    if (val >= 1e9) return (val / 1e9).toFixed(1) + 'B';
                    if (val >= 1e6) return (val / 1e6).toFixed(1) + 'M';
                    if (val >= 1e3) return (val / 1e3).toFixed(1) + 'K';
                    return val.toString();
                }
            };
        }
    </script>
    {% elif hot_tables and hot_tables.error %}
    <div class="glass-card rounded-2xl p-4 border border-midnight-700/50">
        <div class="flex items-center gap-3 text-midnight-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm">Hot Tables: {{ hot_tables.error }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Tabs (Client-side switching with URL persistence) -->
    <div id="tabs" class="glass-card rounded-2xl overflow-hidden scroll-mt-4" 
         x-data="{ 
             currentTab: '{{ tab }}',
             setTab(tab) {
                 this.currentTab = tab;
                 // Update URL without page reload
                 const url = new URL(window.location);
                 url.searchParams.set('tab', tab);
                 history.replaceState(null, '', url);
             }
         }">
        <div class="border-b border-midnight-700/50">
            <nav class="flex overflow-x-auto">
                <button @click="setTab('innodb')" 
                   :class="currentTab === 'innodb' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                    InnoDB Status
                </button>
                <button @click="setTab('global')" 
                   :class="currentTab === 'global' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Global Status
                </button>
                <button @click="setTab('processlist')" 
                   :class="currentTab === 'processlist' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Processlist
                </button>
                <button @click="setTab('config')" 
                   :class="currentTab === 'config' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Config
                </button>
                <button @click="setTab('replication')" 
                   :class="currentTab === 'replication' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    {% if replica_status and replica_status.is_replica %}
                    Replication (replica)
                    <span class="w-2 h-2 rounded-full {{ 'bg-volt-400' if replica_status.seconds_behind_master == 0 else 'bg-yellow-400' if replica_status.seconds_behind_master is none or replica_status.seconds_behind_master < 10 else 'bg-crimson-400' }}"></span>
                    {% elif master_status and master_status.is_master %}
                    Replication (master)
                    <span class="w-2 h-2 rounded-full bg-ocean-400"></span>
                    {% else %}
                    Replication
                    {% endif %}
                </button>
                <button @click="setTab('health')" 
                   :class="currentTab === 'health' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    Health
                    {% if innodb_health and innodb_health.summary and innodb_health.summary.has_issues %}
                    <span class="w-2 h-2 rounded-full {{ 'bg-crimson-400' if innodb_health.summary.issues|selectattr('severity', 'equalto', 'critical')|list else 'bg-yellow-400' }}"></span>
                    {% else %}
                    <span class="w-2 h-2 rounded-full bg-volt-400"></span>
                    {% endif %}
                </button>
                <button @click="setTab('raw')" 
                   :class="currentTab === 'raw' ? 'border-ocean-500 text-ocean-400' : 'border-transparent text-midnight-400 hover:text-white'"
                   class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Raw Output
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Replication Tab -->
            <div x-show="currentTab === 'replication'" x-cloak>
            <div class="space-y-6">
                {% if replica_status and replica_status.is_replica %}
                <!-- Replication Status Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Lag Status -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border
                        {% if replica_status.seconds_behind_master is none %}
                            border-yellow-500/30
                        {% elif replica_status.seconds_behind_master == 0 %}
                            border-volt-500/30
                        {% elif replica_status.seconds_behind_master < 10 %}
                            border-yellow-500/30
                        {% else %}
                            border-crimson-500/30
                        {% endif %}">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-midnight-400 flex items-center">Replication Lag{{ info_tooltip("Seconds_Behind_Master: Estimated time the replica is behind the master. 0 = caught up, NULL = thread not running or undetermined. High lag indicates slow queries, network issues, or replica overload.") }}</span>
                            {% if replica_status.seconds_behind_master == 0 %}
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-volt-500/20 text-volt-400">Caught Up</span>
                            {% elif replica_status.seconds_behind_master is none %}
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-400">Unknown</span>
                            {% elif replica_status.seconds_behind_master < 10 %}
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-400">Lagging</span>
                            {% else %}
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-crimson-500/20 text-crimson-400">Critical</span>
                            {% endif %}
                        </div>
                        <p class="text-3xl font-bold font-mono mt-2
                            {% if replica_status.seconds_behind_master is none %}text-yellow-400
                            {% elif replica_status.seconds_behind_master == 0 %}text-volt-400
                            {% elif replica_status.seconds_behind_master < 10 %}text-yellow-400
                            {% else %}text-crimson-400{% endif %}">
                            {% if replica_status.seconds_behind_master is none %}NULL{% else %}{{ replica_status.seconds_behind_master }}s{% endif %}
                        </p>
                        <p class="text-xs text-midnight-500 mt-1">Seconds Behind Master</p>
                    </div>
                    
                    <!-- IO Thread Status -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-volt-500/30' if replica_status.slave_io_running == 'Yes' else 'border-crimson-500/30' }}">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-midnight-400 flex items-center">IO Thread{{ info_tooltip("Slave_IO_Running: Fetches binary log events from master and writes to relay log. Must be 'Yes' for replication. 'Connecting' may indicate network issues or master unavailability.") }}</span>
                            <span class="w-2 h-2 rounded-full {{ 'bg-volt-400' if replica_status.slave_io_running == 'Yes' else 'bg-crimson-400' }} animate-pulse"></span>
                        </div>
                        <p class="text-3xl font-bold mt-2 {{ 'text-volt-400' if replica_status.slave_io_running == 'Yes' else 'text-crimson-400' }}">
                            {{ replica_status.slave_io_running or 'N/A' }}
                        </p>
                        <p class="text-xs text-midnight-500 mt-1 truncate" title="{{ replica_status.slave_io_state or 'No state info' }}">
                            {{ replica_status.slave_io_state or 'No state info' }}
                        </p>
                    </div>
                    
                    <!-- SQL Thread Status -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-volt-500/30' if replica_status.slave_sql_running == 'Yes' else 'border-crimson-500/30' }}">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-midnight-400 flex items-center">SQL Thread{{ info_tooltip("Slave_SQL_Running: Reads relay log and executes SQL on replica. Must be 'Yes'. 'No' often means replication error (check Last_SQL_Error). Can be stopped deliberately for maintenance.") }}</span>
                            <span class="w-2 h-2 rounded-full {{ 'bg-volt-400' if replica_status.slave_sql_running == 'Yes' else 'bg-crimson-400' }} animate-pulse"></span>
                        </div>
                        <p class="text-3xl font-bold mt-2 {{ 'text-volt-400' if replica_status.slave_sql_running == 'Yes' else 'text-crimson-400' }}">
                            {{ replica_status.slave_sql_running or 'N/A' }}
                        </p>
                        <p class="text-xs text-midnight-500 mt-1 truncate" title="{{ replica_status.slave_sql_state or 'No state info' }}">
                            {{ replica_status.slave_sql_state or 'No state info' }}
                        </p>
                    </div>
                </div>

                <!-- Master Comparison (if master is in this job) -->
                {% if master_info %}
                <div class="bg-gradient-to-r from-ocean-500/10 to-volt-500/10 rounded-xl p-4 border border-ocean-500/30">
                    <h3 class="text-sm font-semibold text-white flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Master Comparison
                        <span class="text-xs text-midnight-400 font-normal">‚Äî Comparing with {{ master_info.label }}</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Master Position -->
                        <div class="bg-midnight-800/50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-ocean-500/20 text-ocean-400">MASTER</span>
                                <span class="text-sm text-midnight-300">{{ master_info.label }}</span>
                            </div>
                            <div class="space-y-1 text-sm font-mono">
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Binlog File:</span>
                                    <span class="text-white">{{ master_info.binlog_file or 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Position:</span>
                                    <span class="text-white">{{ '{:,}'.format(master_info.binlog_position) if master_info.binlog_position else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Replica Position -->
                        <div class="bg-midnight-800/50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-volt-500/20 text-volt-400">REPLICA</span>
                                <span class="text-sm text-midnight-300">{{ host_label }}</span>
                            </div>
                            <div class="space-y-1 text-sm font-mono">
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Reading File:</span>
                                    <span class="text-white">{{ replica_status.master_log_file or 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Read Position:</span>
                                    <span class="text-white">{{ '{:,}'.format(replica_status.read_master_log_pos) if replica_status.read_master_log_pos else 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Executing File:</span>
                                    <span class="text-white">{{ replica_status.relay_master_log_file or 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Exec Position:</span>
                                    <span class="text-white">{{ '{:,}'.format(replica_status.exec_master_log_pos) if replica_status.exec_master_log_pos else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Difference -->
                    {% if master_info.binlog_position and replica_status.exec_master_log_pos %}
                    {% set pos_diff = master_info.binlog_position - replica_status.exec_master_log_pos %}
                    <div class="mt-3 p-2 rounded-lg {{ 'bg-volt-500/10 border border-volt-500/30' if pos_diff == 0 else 'bg-yellow-500/10 border border-yellow-500/30' if pos_diff < 1000000 else 'bg-crimson-500/10 border border-crimson-500/30' }}">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-midnight-400">Position Difference:</span>
                            <span class="font-mono font-bold {{ 'text-volt-400' if pos_diff == 0 else 'text-yellow-400' if pos_diff < 1000000 else 'text-crimson-400' }}">
                                {% if pos_diff == 0 %}
                                ‚úì Caught up
                                {% elif master_info.binlog_file != replica_status.relay_master_log_file %}
                                ‚ö† Different binlog file
                                {% else %}
                                {{ '{:,}'.format(pos_diff) }} bytes behind
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Binlog Position Details -->
                <div class="bg-midnight-800/50 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-white flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Binlog Position Details
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- IO Thread (Reading) -->
                        <div class="space-y-2">
                            <h4 class="text-xs font-medium text-midnight-400 uppercase tracking-wider">IO Thread (Reading from Master)</h4>
                            <div class="bg-midnight-900/50 rounded-lg p-3 space-y-2 text-sm font-mono">
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Master Log File:</span>
                                    <span class="text-ocean-300">{{ replica_status.master_log_file or 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Read Position:</span>
                                    <span class="text-white">{{ '{:,}'.format(replica_status.read_master_log_pos) if replica_status.read_master_log_pos else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SQL Thread (Executing) -->
                        <div class="space-y-2">
                            <h4 class="text-xs font-medium text-midnight-400 uppercase tracking-wider">SQL Thread (Executing)</h4>
                            <div class="bg-midnight-900/50 rounded-lg p-3 space-y-2 text-sm font-mono">
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Relay Master File:</span>
                                    <span class="text-ocean-300">{{ replica_status.relay_master_log_file or 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-midnight-500">Exec Position:</span>
                                    <span class="text-white">{{ '{:,}'.format(replica_status.exec_master_log_pos) if replica_status.exec_master_log_pos else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relay Log Info -->
                    <div class="mt-4 space-y-2">
                        <h4 class="text-xs font-medium text-midnight-400 uppercase tracking-wider">Relay Log</h4>
                        <div class="bg-midnight-900/50 rounded-lg p-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-mono">
                            <div>
                                <span class="text-midnight-500 block">Relay Log File:</span>
                                <span class="text-white">{{ replica_status.relay_log_file or 'N/A' }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-500 block">Relay Log Pos:</span>
                                <span class="text-white">{{ '{:,}'.format(replica_status.relay_log_pos) if replica_status.relay_log_pos else 'N/A' }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-500 block">Relay Log Space:</span>
                                <span class="text-white">{{ '{:,.0f}'.format(replica_status.relay_log_space / 1024 / 1024) if replica_status.relay_log_space else 'N/A' }} MB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GTID Information -->
                {% if replica_status.auto_position or replica_status.retrieved_gtid_set or replica_status.executed_gtid_set %}
                <div class="bg-midnight-800/50 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-white flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-volt-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                        </svg>
                        GTID Replication
                        {% if replica_status.auto_position %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-volt-500/20 text-volt-400">Auto Position</span>
                        {% endif %}
                    </h3>
                    <div class="space-y-3">
                        {% if replica_status.retrieved_gtid_set %}
                        <div>
                            <span class="text-xs text-midnight-400 uppercase tracking-wider">Retrieved GTID Set</span>
                            <pre class="mt-1 p-2 bg-midnight-900/50 rounded-lg text-xs font-mono text-ocean-300 overflow-x-auto">{{ replica_status.retrieved_gtid_set }}</pre>
                        </div>
                        {% endif %}
                        {% if replica_status.executed_gtid_set %}
                        <div>
                            <span class="text-xs text-midnight-400 uppercase tracking-wider">Executed GTID Set</span>
                            <pre class="mt-1 p-2 bg-midnight-900/50 rounded-lg text-xs font-mono text-volt-300 overflow-x-auto">{{ replica_status.executed_gtid_set }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Source Connection Info -->
                <div class="bg-midnight-800/50 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-white flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
                        </svg>
                        Source Connection
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-midnight-500 block">Master Host:</span>
                            <span class="text-white font-mono">{{ replica_status.master_host or 'N/A' }}</span>
                        </div>
                        <div>
                            <span class="text-midnight-500 block">Master Port:</span>
                            <span class="text-white font-mono">{{ replica_status.master_port or 'N/A' }}</span>
                        </div>
                        <div>
                            <span class="text-midnight-500 block">Master User:</span>
                            <span class="text-white font-mono">{{ replica_status.master_user or 'N/A' }}</span>
                        </div>
                        <div>
                            <span class="text-midnight-500 block">Connect Retry:</span>
                            <span class="text-white font-mono">{{ replica_status.connect_retry or 'N/A' }}s</span>
                        </div>
                        {% if replica_status.master_server_id %}
                        <div>
                            <span class="text-midnight-500 block">Master Server ID:</span>
                            <span class="text-white font-mono">{{ replica_status.master_server_id }}</span>
                        </div>
                        {% endif %}
                        {% if replica_status.master_uuid %}
                        <div class="col-span-2">
                            <span class="text-midnight-500 block">Master UUID:</span>
                            <span class="text-white font-mono text-xs">{{ replica_status.master_uuid }}</span>
                        </div>
                        {% endif %}
                        {% if replica_status.channel_name %}
                        <div>
                            <span class="text-midnight-500 block">Channel:</span>
                            <span class="text-white font-mono">{{ replica_status.channel_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Errors (if any) -->
                {% if replica_status.last_io_error or replica_status.last_sql_error %}
                <div class="bg-crimson-500/10 border border-crimson-500/30 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-crimson-400 flex items-center gap-2 mb-3">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Replication Errors
                    </h3>
                    {% if replica_status.last_io_error %}
                    <div class="mb-2">
                        <span class="text-xs text-crimson-300 font-medium">IO Error ({{ replica_status.last_io_errno or '?' }}):</span>
                        <p class="text-sm text-crimson-200 mt-1">{{ replica_status.last_io_error }}</p>
                    </div>
                    {% endif %}
                    {% if replica_status.last_sql_error %}
                    <div>
                        <span class="text-xs text-crimson-300 font-medium">SQL Error ({{ replica_status.last_sql_errno or '?' }}):</span>
                        <p class="text-sm text-crimson-200 mt-1">{{ replica_status.last_sql_error }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% elif master_status and master_status.is_master %}
                <!-- This is a Master Server -->
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto rounded-full bg-ocean-500/20 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">Primary Server (Master)</h3>
                    <p class="text-midnight-400 mb-6">This server is configured as a master with binary logging enabled.</p>
                    
                    <div class="max-w-md mx-auto bg-midnight-800/50 rounded-xl p-4">
                        <h4 class="text-sm font-semibold text-white mb-3">Master Status</h4>
                        <div class="space-y-2 text-sm font-mono">
                            <div class="flex justify-between">
                                <span class="text-midnight-500">Binlog File:</span>
                                <span class="text-ocean-300">{{ master_status.file }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-midnight-500">Position:</span>
                                <span class="text-white">{{ '{:,}'.format(master_status.position) if master_status.position else 'N/A' }}</span>
                            </div>
                            {% if master_status.executed_gtid_set %}
                            <div class="pt-2 border-t border-midnight-700">
                                <span class="text-midnight-500 block mb-1">Executed GTID Set:</span>
                                <span class="text-volt-300 text-xs break-all">{{ master_status.executed_gtid_set }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- No Replication -->
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto rounded-full bg-midnight-700 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-midnight-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-midnight-400 mb-2">No Replication Configured</h3>
                    <p class="text-midnight-500">This server is not configured as a replica and does not have binary logging enabled.</p>
                </div>
                {% endif %}
            </div>
            </div>

            <!-- Health Tab -->
            <div x-show="currentTab === 'health'" x-cloak class="space-y-6">
                {% if innodb_health %}
                
                <!-- Health Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Overall Status -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-crimson-500/30' if innodb_health.summary.has_issues and innodb_health.summary.issues|selectattr('severity', 'equalto', 'critical')|list else 'border-yellow-500/30' if innodb_health.summary.has_issues else 'border-volt-500/30' }}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-midnight-400">Overall Status</span>
                            {% if innodb_health.summary.has_issues %}
                            {% if innodb_health.summary.issues|selectattr('severity', 'equalto', 'critical')|list %}
                            <span class="text-crimson-400">üî¥</span>
                            {% else %}
                            <span class="text-yellow-400">üü°</span>
            {% endif %}
                            {% else %}
                            <span class="text-volt-400">üü¢</span>
                            {% endif %}
                        </div>
                        <p class="text-lg font-semibold {{ 'text-crimson-400' if innodb_health.summary.has_issues and innodb_health.summary.issues|selectattr('severity', 'equalto', 'critical')|list else 'text-yellow-400' if innodb_health.summary.has_issues else 'text-volt-400' }}">
                            {% if innodb_health.summary.has_issues %}
                            {{ innodb_health.summary.issues|length }} Issue(s)
                            {% else %}
                            Healthy
                            {% endif %}
                        </p>
                    </div>
                    
                    <!-- Deadlock Status -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-crimson-500/30' if innodb_health.deadlock.has_deadlock else 'border-midnight-700' }}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-midnight-400 flex items-center">Deadlocks{{ info_tooltip("A deadlock occurs when two or more transactions hold locks that the other needs. MySQL automatically detects and rolls back one transaction (the 'victim'). Frequent deadlocks indicate contention issues requiring query or schema optimization.") }}</span>
                            <span class="{{ 'text-crimson-400' if innodb_health.deadlock.has_deadlock else 'text-volt-400' }}">{{ 'üî¥' if innodb_health.deadlock.has_deadlock else 'üü¢' }}</span>
                        </div>
                        <p class="text-lg font-semibold {{ 'text-crimson-400' if innodb_health.deadlock.has_deadlock else 'text-midnight-300' }}">
                            {% if innodb_health.deadlock.has_deadlock %}
                            Detected
                            {% else %}
                            None
                            {% endif %}
                        </p>
                        {% if innodb_health.deadlock.timestamp %}
                        <p class="text-xs text-midnight-500 mt-1">Last: {{ innodb_health.deadlock.timestamp }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Lock Contention -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-crimson-500/30' if innodb_health.lock_contention.lock_waiting_transactions > 5 else 'border-yellow-500/30' if innodb_health.lock_contention.has_contention else 'border-midnight-700' }}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-midnight-400 flex items-center">Lock Contention{{ info_tooltip("Number of transactions waiting to acquire locks. High values indicate concurrent access to same rows. Consider optimizing transaction scope, adding indexes, or changing isolation level.") }}</span>
                            <span class="{{ 'text-crimson-400' if innodb_health.lock_contention.lock_waiting_transactions > 5 else 'text-yellow-400' if innodb_health.lock_contention.has_contention else 'text-volt-400' }}">{{ 'üî¥' if innodb_health.lock_contention.lock_waiting_transactions > 5 else 'üü°' if innodb_health.lock_contention.has_contention else 'üü¢' }}</span>
                        </div>
                        <p class="text-lg font-semibold font-mono {{ 'text-crimson-400' if innodb_health.lock_contention.lock_waiting_transactions > 5 else 'text-yellow-400' if innodb_health.lock_contention.has_contention else 'text-midnight-300' }}">
                            {{ innodb_health.lock_contention.lock_waiting_transactions }} waiting
                        </p>
                        {% if innodb_health.lock_contention.history_list_length %}
                        <p class="text-xs text-midnight-500 mt-1">History: {{ innodb_health.lock_contention.history_list_length }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Redo Log Health -->
                    <div class="bg-midnight-800/50 rounded-xl p-4 border {{ 'border-crimson-500/30' if innodb_health.redo_log.health == 'critical' else 'border-yellow-500/30' if innodb_health.redo_log.health == 'warning' else 'border-midnight-700' }}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-midnight-400 flex items-center">Redo Log{{ info_tooltip("Checkpoint age shows unflushed redo log data. Warning at 80%+ of log capacity, critical at 90%+. High values cause aggressive flushing and performance degradation. Consider increasing innodb_log_file_size.") }}</span>
                            <span class="{{ 'text-crimson-400' if innodb_health.redo_log.health == 'critical' else 'text-yellow-400' if innodb_health.redo_log.health == 'warning' else 'text-volt-400' }}">{{ 'üî¥' if innodb_health.redo_log.health == 'critical' else 'üü°' if innodb_health.redo_log.health == 'warning' else 'üü¢' }}</span>
                        </div>
                        <p class="text-lg font-semibold font-mono {{ 'text-crimson-400' if innodb_health.redo_log.health == 'critical' else 'text-yellow-400' if innodb_health.redo_log.health == 'warning' else 'text-midnight-300' }}">
                            {{ innodb_health.redo_log.checkpoint_age_mb | round(1) }} MB
                        </p>
                        <p class="text-xs text-midnight-500 mt-1">Checkpoint age</p>
                    </div>
                </div>
                
                <!-- Issues List -->
                {% if innodb_health.summary.has_issues %}
                <div class="bg-midnight-800/50 rounded-xl border border-midnight-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-midnight-700 bg-midnight-800/50">
                        <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                            <svg class="w-4 h-4 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            Active Issues
                        </h3>
                    </div>
                    <div class="divide-y divide-midnight-700/50">
                        {% for issue in innodb_health.summary.issues|sort(attribute='severity', reverse=true) %}
                        <div class="px-4 py-3 flex items-center gap-3">
                            <span class="{{ 'text-crimson-400' if issue.severity == 'critical' else 'text-yellow-400' }}">
                                {{ 'üî¥' if issue.severity == 'critical' else 'üü°' }}
                            </span>
                            <div class="flex-1">
                                <p class="text-sm text-white">{{ issue.message }}</p>
                                <p class="text-xs text-midnight-500">Category: {{ issue.category }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Detailed Sections -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Deadlock Details -->
                    {% if innodb_health.deadlock.has_deadlock %}
                    <div class="bg-midnight-800/50 rounded-xl border border-crimson-500/30 overflow-hidden">
                        <div class="px-4 py-3 border-b border-midnight-700 bg-crimson-500/10">
                            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                                <svg class="w-4 h-4 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                Deadlock Details
                                {{ info_tooltip("Shows the last detected deadlock from SHOW ENGINE INNODB STATUS. The 'victim' transaction was automatically rolled back by MySQL. Analyze the queries involved to prevent future deadlocks.") }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-3">
                            {% if innodb_health.deadlock.timestamp %}
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Last detected:</span>
                                <span class="text-white font-mono">{{ innodb_health.deadlock.timestamp }}</span>
                            </div>
                            {% endif %}
                            {% for trx in innodb_health.deadlock.transactions %}
                            <div class="bg-midnight-900/50 rounded-lg p-3 border {{ 'border-crimson-500/50' if trx.was_rolled_back else 'border-midnight-700' }}">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-medium text-white">Transaction {{ loop.index }}</span>
                                    <div class="flex items-center gap-2">
                                        {% if trx.active_time %}
                                        <span class="text-xs px-2 py-0.5 rounded-full bg-midnight-700 text-midnight-300">{{ trx.active_time }}s active</span>
                                        {% endif %}
                                        {% if trx.was_rolled_back %}
                                        <span class="text-xs px-2 py-0.5 rounded-full bg-crimson-500/20 text-crimson-400 border border-crimson-500/30">Victim (Rolled Back)</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- User & Connection Info -->
                                {% if trx.user or trx.thread_id %}
                                <div class="grid grid-cols-2 gap-2 mb-2 text-xs">
                                    {% if trx.user %}
                                    <div class="text-midnight-400">User: <span class="text-yellow-400 font-mono">{{ trx.user }}@{{ trx.host or '?' }}</span></div>
                                    {% endif %}
                                    {% if trx.thread_id %}
                                    <div class="text-midnight-400">Thread: <span class="text-white font-mono">{{ trx.thread_id }}</span></div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Lock Info -->
                                {% if trx.row_locks or trx.lock_structs %}
                                <div class="grid grid-cols-3 gap-2 mb-2 text-xs">
                                    {% if trx.row_locks %}
                                    <div class="text-midnight-400">Row Locks: <span class="text-crimson-400 font-mono">{{ trx.row_locks }}</span></div>
                                    {% endif %}
                                    {% if trx.lock_structs %}
                                    <div class="text-midnight-400">Lock Structs: <span class="text-white font-mono">{{ trx.lock_structs }}</span></div>
                                    {% endif %}
                                    {% if trx.undo_log_entries %}
                                    <div class="text-midnight-400">Undo Entries: <span class="text-white font-mono">{{ trx.undo_log_entries }}</span></div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Table & Index -->
                                {% if trx.table or trx.index %}
                                <div class="grid grid-cols-2 gap-2 mb-2 text-xs">
                                    {% if trx.table %}
                                    <div class="text-midnight-400">Table: <span class="text-ocean-400 font-mono">{{ trx.table }}</span></div>
                                    {% endif %}
                                    {% if trx.index %}
                                    <div class="text-midnight-400">Index: <span class="text-volt-400 font-mono">{{ trx.index }}</span></div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Operation & State -->
                                {% if trx.operation or trx.state %}
                                <div class="text-xs text-midnight-400 mb-2">
                                    Operation: <span class="text-white font-medium">{{ trx.operation or trx.state or 'Unknown' }}</span>
                                </div>
                                {% endif %}
                                
                                <!-- Query (collapsible with copy) -->
                                {% if trx.query %}
                                <div class="mt-2" x-data="{ expanded: false, copied: false }">
                                    <div class="flex items-center justify-between mb-1">
                                        <p class="text-xs text-midnight-500">Query:</p>
                                        <div class="flex items-center gap-2">
                                            <button @click="navigator.clipboard.writeText($refs.sqlQuery{{ loop.index }}.textContent); copied = true; setTimeout(() => copied = false, 2000)"
                                                    class="text-xs px-2 py-0.5 rounded bg-midnight-700 text-midnight-400 hover:text-white transition-colors">
                                                <span x-show="!copied">üìã Copy</span>
                                                <span x-show="copied" class="text-volt-400">‚úì Copied</span>
                                            </button>
                                            {% if trx.query|length > 150 %}
                                            <button @click="expanded = !expanded" class="text-xs text-ocean-400 hover:text-ocean-300">
                                                <span x-show="!expanded">‚ñº Expand</span>
                                                <span x-show="expanded">‚ñ≤ Collapse</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="p-2 bg-midnight-800 rounded border border-midnight-700 overflow-x-auto" :class="!expanded && '{{ 'max-h-20' if trx.query|length > 150 else '' }}'">
                                        <code x-ref="sqlQuery{{ loop.index }}" class="text-xs font-mono text-ocean-200 whitespace-pre-wrap break-all block">{{ trx.query }}</code>
                                    </div>
                                    {% if trx.query|length > 150 %}
                                    <div x-show="!expanded" class="text-right mt-1">
                                        <span class="text-xs text-midnight-500">{{ trx.query|length }} chars ‚Ä¢ click Expand to see full query</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Lock Contention Details -->
                    {% if innodb_health.lock_contention.has_contention and innodb_health.lock_contention.lock_wait_details %}
                    <div class="bg-midnight-800/50 rounded-xl border border-yellow-500/30 overflow-hidden">
                        <div class="px-4 py-3 border-b border-midnight-700 bg-yellow-500/10">
                            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                                <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Waiting Transactions
                                {{ info_tooltip("Transactions blocked waiting for locks held by other transactions. Long wait times may indicate hot-spot contention. Consider splitting large transactions or adding appropriate indexes.") }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-2">
                            {% for detail in innodb_health.lock_contention.lock_wait_details %}
                            <div class="bg-midnight-900/50 rounded-lg p-3 border border-midnight-700">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-mono text-white">Trx {{ detail.trx_id }}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
                                        {{ detail.wait_seconds }}s waiting
                                    </span>
                                </div>
                                {% if detail.table %}
                                <div class="text-xs text-midnight-400 mt-1">Table: <span class="text-ocean-400 font-mono">{{ detail.table }}</span></div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Hot Indexes -->
                    {% if innodb_health.hot_indexes.hot_indexes %}
                    <div class="bg-midnight-800/50 rounded-xl border border-ocean-500/30 overflow-hidden">
                        <div class="px-4 py-3 border-b border-midnight-700 bg-ocean-500/10">
                            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                                <svg class="w-4 h-4 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                                </svg>
                                Hot Indexes (Contention)
                                {{ info_tooltip("Indexes experiencing lock waits from SHOW ENGINE INNODB STATUS. These are bottlenecks where multiple transactions compete for locks. Consider query optimization or schema changes.") }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-2">
                            {% for idx in innodb_health.hot_indexes.hot_indexes %}
                            <div class="bg-midnight-900/50 rounded-lg p-3 border border-midnight-700">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-mono text-ocean-400">{{ idx.index }}</span>
                                    <span class="text-xs text-midnight-400">{{ idx.contention_count }} hit(s)</span>
                                </div>
                                <div class="text-xs text-midnight-400">Table: <span class="text-white">{{ idx.table }}</span></div>
                                {% if idx.lock_types %}
                                <div class="flex gap-1 mt-2">
                                    {% for lock_type in idx.lock_types %}
                                    <span class="text-xs px-1.5 py-0.5 rounded bg-midnight-700 text-midnight-300">{{ lock_type }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Semaphore/Mutex Health -->
                    <div class="bg-midnight-800/50 rounded-xl border {{ 'border-yellow-500/30' if innodb_health.semaphore.has_mutex_contention else 'border-midnight-700' }} overflow-hidden">
                        <div class="px-4 py-3 border-b border-midnight-700">
                            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                                <svg class="w-4 h-4 text-midnight-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                </svg>
                                Semaphore / Mutex
                                {{ info_tooltip("Internal InnoDB locking metrics. RW-Shared: read locks (multiple readers). RW-Excl: exclusive write locks. RW-SX: shared-exclusive locks (read that may upgrade). High spin waits or OS waits may indicate internal contention.") }}
                            </h3>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center">
                                    <p class="text-lg font-mono font-semibold text-white">{{ innodb_health.semaphore.rw_shared_os_waits | default(0) }}</p>
                                    <p class="text-xs text-midnight-400">RW-Shared</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-lg font-mono font-semibold text-white">{{ innodb_health.semaphore.rw_excl_os_waits | default(0) }}</p>
                                    <p class="text-xs text-midnight-400">RW-Excl</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-lg font-mono font-semibold text-white">{{ innodb_health.semaphore.rw_sx_os_waits | default(0) }}</p>
                                    <p class="text-xs text-midnight-400">RW-SX</p>
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <span class="text-sm {{ 'text-yellow-400' if innodb_health.semaphore.has_mutex_contention else 'text-volt-400' }}">
                                    {{ 'Mutex contention detected' if innodb_health.semaphore.has_mutex_contention else 'No mutex contention' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Redo Log Details -->
                    <div class="bg-midnight-800/50 rounded-xl border {{ 'border-crimson-500/30' if innodb_health.redo_log.health == 'critical' else 'border-yellow-500/30' if innodb_health.redo_log.health == 'warning' else 'border-midnight-700' }} overflow-hidden">
                        <div class="px-4 py-3 border-b border-midnight-700">
                            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                                <svg class="w-4 h-4 text-midnight-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Redo Log Details
                                {{ info_tooltip("LSN is a byte counter that increases with each write. Checkpoint Age = LSN - Last Checkpoint represents unflushed data. If age approaches total redo log size, MySQL forces synchronous flushing.") }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Log Sequence Number:</span>
                                <span class="text-white font-mono">
                                    {{ "{:,}".format(innodb_health.redo_log.log_sequence_number | default(0)) }}
                                </span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Last Checkpoint:</span>
                                <span class="text-white font-mono">
                                    {{ "{:,}".format(innodb_health.redo_log.last_checkpoint | default(0)) }}
                                </span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Checkpoint Age:</span>
                                <span class="font-mono {{ 'text-crimson-400' if innodb_health.redo_log.health == 'critical' else 'text-yellow-400' if innodb_health.redo_log.health == 'warning' else 'text-volt-400' }}" title="{{ innodb_health.redo_log.checkpoint_age_bytes | default(0) }} bytes">
                                    {{ innodb_health.redo_log.checkpoint_age_bytes | format_bytes }}
                                </span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Log I/Os Done:</span>
                                <span class="text-white font-mono" title="{{ innodb_health.redo_log.log_ios_done | default(0) }}">
                                    {{ innodb_health.redo_log.log_ios_done | format_number }}
                                </span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Log I/Os/sec:</span>
                                <span class="text-white font-mono">{{ innodb_health.redo_log.log_ios_per_sec | format_number }}</span>
                            </div>
                            {% if innodb_health.redo_log.trend %}
                            <div class="flex justify-between text-sm">
                                <span class="text-midnight-400">Trend:</span>
                                <span class="text-midnight-300">{{ innodb_health.redo_log.trend | capitalize }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- No Health Data -->
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto rounded-full bg-midnight-700 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-midnight-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-midnight-400 mb-2">No Health Data Available</h3>
                    <p class="text-midnight-500">InnoDB health analysis is not available for this snapshot.<br>Re-run collection to generate health data.</p>
                </div>
                {% endif %}
            </div>

            <!-- Raw Output Tab -->
            <div x-show="currentTab === 'raw'" x-cloak class="space-y-3">
                <div class="flex justify-end">
                    <button id="copy-raw-btn" onclick="copyToClipboard('raw-output', 'copy-raw-btn')"
                            class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700">
                        <svg id="copy-raw-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span id="copy-raw-text">Copy to Clipboard</span>
                    </button>
                </div>
                <div class="code-block rounded-xl p-4 max-h-[600px] overflow-auto">
                    <pre id="raw-output" class="font-mono text-sm text-ocean-200 whitespace-pre-wrap break-words">{{ raw_output }}</pre>
                </div>
            </div>

            <!-- InnoDB Tab -->
            <div x-show="currentTab === 'innodb'" x-cloak class="space-y-6" x-data="{ showRaw: false }">
                <!-- Header with timestamp and toggle -->
                {% if innodb_structured %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        {% if innodb_structured.header.timestamp %}
                        <span class="text-sm text-midnight-400">
                            <span class="text-midnight-500">Captured:</span> {{ innodb_structured.header.timestamp }}
                        </span>
                        {% endif %}
                        {% if innodb_structured.header.avg_interval %}
                        <span class="text-sm text-midnight-400">
                            <span class="text-midnight-500">Avg interval:</span> {{ innodb_structured.header.avg_interval }}s
                        </span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="showRaw = !showRaw" 
                                class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                                :class="showRaw ? 'bg-ocean-500/20 text-ocean-400' : 'bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700'">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            <span x-text="showRaw ? 'Show Parsed' : 'Show Raw'"></span>
                        </button>
                        <button id="copy-innodb-btn" onclick="copyToClipboard('innodb-output', 'copy-innodb-btn')"
                                class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span>Copy Raw</span>
                        </button>
                    </div>
                </div>

                <!-- Raw Output (hidden by default) -->
                <div x-show="showRaw" x-cloak class="code-block rounded-xl p-4 max-h-[600px] overflow-auto">
                    <pre id="innodb-output" class="font-mono text-sm text-ocean-200 whitespace-pre-wrap">{{ innodb_output }}</pre>
                </div>

                <!-- Parsed View -->
                <div x-show="!showRaw" class="space-y-6">
                    <!-- Key Metrics Overview -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        {% if innodb_structured.buffer_pool %}
                        <div class="bg-gradient-to-br from-ocean-900/50 to-midnight-800/50 rounded-xl p-4 border border-ocean-700/30">
                            <div class="text-xs text-ocean-400 uppercase tracking-wide mb-1 flex items-center">
                                Buffer Pool Hit Rate
                                {{ info_tooltip("Ratio of page reads satisfied from buffer pool vs disk. Higher is better. Values above 99% indicate excellent caching. Low hit rates suggest buffer pool may be too small for workload.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ innodb_structured.buffer_pool.hit_rate_num }}/{{ innodb_structured.buffer_pool.hit_rate_denom }}</div>
                            <div class="text-xs text-midnight-400 mt-1">{{ "%.1f"|format(innodb_structured.buffer_pool.hit_rate_num / innodb_structured.buffer_pool.hit_rate_denom * 100) }}%</div>
                        </div>
                        <div class="bg-gradient-to-br from-volt-500/10 to-midnight-800/50 rounded-xl p-4 border border-volt-500/30">
                            <div class="text-xs text-volt-400 uppercase tracking-wide mb-1 flex items-center">
                                Pool Utilization
                                {{ info_tooltip("Percentage of buffer pool containing actual data pages. High utilization (90%+) is normal for busy databases. Very low values may indicate over-provisioned memory.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ innodb_structured.buffer_pool.utilization_pct|default(0) }}%</div>
                            <div class="text-xs text-midnight-400 mt-1">{{ "{:,}".format(innodb_structured.buffer_pool.database_pages) }} pages</div>
                        </div>
                        <div class="bg-gradient-to-br from-ember-500/10 to-midnight-800/50 rounded-xl p-4 border border-ember-500/30">
                            <div class="text-xs text-ember-400 uppercase tracking-wide mb-1 flex items-center">
                                Dirty Pages
                                {{ info_tooltip("Pages modified in memory but not yet written to disk. Some dirty pages are normal. Very high counts may indicate I/O bottleneck or aggressive checkpointing needed.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ "{:,}".format(innodb_structured.buffer_pool.modified_pages) }}</div>
                            <div class="text-xs text-midnight-400 mt-1">{{ innodb_structured.buffer_pool.dirty_pct|default(0) }}% of pool</div>
                        </div>
                        {% endif %}
                        {% if innodb_structured.transactions %}
                        <div class="bg-gradient-to-br from-purple-500/10 to-midnight-800/50 rounded-xl p-4 border border-purple-500/30">
                            <div class="text-xs text-purple-400 uppercase tracking-wide mb-1 flex items-center">
                                History List
                                {{ info_tooltip("Number of undo log pages waiting to be purged. High values (100K+) indicate long-running transactions blocking purge, leading to increased disk usage and slower queries.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ "{:,}".format(innodb_structured.transactions.history_list_length) }}</div>
                            <div class="text-xs text-midnight-400 mt-1">purge lag</div>
                        </div>
                        <div class="bg-gradient-to-br from-cyan-500/10 to-midnight-800/50 rounded-xl p-4 border border-cyan-500/30">
                            <div class="text-xs text-cyan-400 uppercase tracking-wide mb-1 flex items-center">
                                Active Transactions
                                {{ info_tooltip("Currently open transactions that haven't committed or rolled back. High counts may indicate connection leaks, stuck queries, or application issues with transaction management.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ innodb_structured.transactions.active }}</div>
                            <div class="text-xs text-midnight-400 mt-1">of {{ innodb_structured.transactions.total_transactions }} total</div>
                        </div>
                        {% endif %}
                        {% if innodb_structured.row_operations %}
                        <div class="bg-gradient-to-br from-pink-500/10 to-midnight-800/50 rounded-xl p-4 border border-pink-500/30">
                            <div class="text-xs text-pink-400 uppercase tracking-wide mb-1 flex items-center">
                                Queries in InnoDB
                                {{ info_tooltip("Queries currently executing inside InnoDB kernel. 'In queue' shows waiting queries. High queue values indicate contention or slow operations blocking other queries.") }}
                            </div>
                            <div class="text-2xl font-bold text-white">{{ innodb_structured.row_operations.queries_inside }}</div>
                            <div class="text-xs text-midnight-400 mt-1">{{ innodb_structured.row_operations.queries_in_queue }} in queue</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Row Operations Section -->
                    {% if innodb_structured.row_operations %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Row Operations
                            {{ info_tooltip("Real-time throughput of InnoDB row operations. High reads/s with low writes may indicate read-heavy workload. Useful for capacity planning and detecting workload changes.") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-midnight-900/50 rounded-lg">
                                <div class="text-2xl font-bold text-green-400">{{ "%.1f"|format(innodb_structured.row_operations.inserts_per_sec) }}</div>
                                <div class="text-xs text-midnight-400 mt-1">Inserts/sec</div>
                                <div class="text-sm text-midnight-500 mt-1">{{ "{:,}".format(innodb_structured.row_operations.rows_inserted) }} total</div>
                            </div>
                            <div class="text-center p-3 bg-midnight-900/50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-400">{{ "%.1f"|format(innodb_structured.row_operations.updates_per_sec) }}</div>
                                <div class="text-xs text-midnight-400 mt-1">Updates/sec</div>
                                <div class="text-sm text-midnight-500 mt-1">{{ "{:,}".format(innodb_structured.row_operations.rows_updated) }} total</div>
                            </div>
                            <div class="text-center p-3 bg-midnight-900/50 rounded-lg">
                                <div class="text-2xl font-bold text-red-400">{{ "%.1f"|format(innodb_structured.row_operations.deletes_per_sec) }}</div>
                                <div class="text-xs text-midnight-400 mt-1">Deletes/sec</div>
                                <div class="text-sm text-midnight-500 mt-1">{{ "{:,}".format(innodb_structured.row_operations.rows_deleted) }} total</div>
                            </div>
                            <div class="text-center p-3 bg-midnight-900/50 rounded-lg">
                                <div class="text-2xl font-bold text-ocean-400">{{ "%.1f"|format(innodb_structured.row_operations.reads_per_sec) }}</div>
                                <div class="text-xs text-midnight-400 mt-1">Reads/sec</div>
                                <div class="text-sm text-midnight-500 mt-1">{{ "{:,}".format(innodb_structured.row_operations.rows_read) }} total</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Buffer Pool Section -->
                    {% if innodb_structured.buffer_pool %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-volt-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                            </svg>
                            Buffer Pool & Memory
                            {{ info_tooltip("InnoDB's main memory cache for data and indexes. Typically set to 70-80% of available RAM. 'Made Young' tracks pages promoted to hot end of LRU list; 'Not Made Young' shows pages accessed but not promoted (configured by innodb_old_blocks_time).") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-sm">
                            <div>
                                <div class="text-midnight-400">Pool Size</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pool_size) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Free Buffers</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.free_buffers) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Database Pages</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.database_pages) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Modified Pages</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.modified_pages) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Pending Reads</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pending_reads) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Pages Read</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pages_read) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Pages Created</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pages_created) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Pages Written</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pages_written) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Made Young</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pages_made_young) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Not Made Young</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.buffer_pool.pages_not_made_young) }}</div>
                            </div>
                        </div>
                        <!-- Utilization Bar -->
                        <div class="mt-4">
                            <div class="flex justify-between text-xs text-midnight-400 mb-1">
                                <span>Buffer Pool Utilization</span>
                                <span>{{ innodb_structured.buffer_pool.utilization_pct|default(0) }}%</span>
                            </div>
                            <div class="h-3 bg-midnight-900 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-ocean-500 to-volt-500 rounded-full transition-all" 
                                     style="width: {{ innodb_structured.buffer_pool.utilization_pct|default(0) }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Log Section -->
                    {% if innodb_structured.log %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Redo Log
                            {{ info_tooltip("Write-ahead log for crash recovery. LSN (Log Sequence Number) is a byte offset that grows with each write. Checkpoint Age = LSN - Last Checkpoint; if it approaches redo log size, performance may degrade as checkpoint flushing is forced.") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-midnight-400">Log Sequence Number</div>
                                <div class="text-white font-mono text-xs">{{ "{:,}".format(innodb_structured.log.log_sequence_number) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Log Flushed To</div>
                                <div class="text-white font-mono text-xs">{{ "{:,}".format(innodb_structured.log.log_flushed_up_to) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Last Checkpoint</div>
                                <div class="text-white font-mono text-xs">{{ "{:,}".format(innodb_structured.log.last_checkpoint) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Checkpoint Age</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.log.checkpoint_age|default(0)) }} bytes</div>
                            </div>
                        </div>
                        <div class="mt-3 text-sm">
                            <span class="text-midnight-400">Log I/Os Done:</span>
                            <span class="text-white font-mono ml-2">{{ "{:,}".format(innodb_structured.log.log_ios_done) }}</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- File I/O Section -->
                    {% if innodb_structured.file_io %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-ember-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            File I/O
                            {{ info_tooltip("Disk operations performed by InnoDB. fsyncs are the most expensive (forces write to physical disk). High fsync rates may indicate write-heavy workload. Read/Write thread counts are configured via innodb_read_io_threads and innodb_write_io_threads.") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="text-midnight-400">OS File Reads</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.file_io.os_file_reads) }}</div>
                                <div class="text-xs text-ocean-400">{{ innodb_structured.file_io.reads_per_sec }}/s</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">OS File Writes</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.file_io.os_file_writes) }}</div>
                                <div class="text-xs text-volt-400">{{ innodb_structured.file_io.writes_per_sec }}/s</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">OS fsyncs</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.file_io.os_fsyncs) }}</div>
                                <div class="text-xs text-ember-400">{{ innodb_structured.file_io.fsyncs_per_sec }}/s</div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-6 text-sm">
                            <div>
                                <span class="text-midnight-400">I/O Threads:</span>
                                <span class="text-white ml-2">{{ innodb_structured.file_io.io_threads_count }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-400">Read Threads:</span>
                                <span class="text-white ml-2">{{ innodb_structured.file_io.read_threads }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-400">Write Threads:</span>
                                <span class="text-white ml-2">{{ innodb_structured.file_io.write_threads }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Insert Buffer & Adaptive Hash Index -->
                    {% if innodb_structured.insert_buffer %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            Insert Buffer & Adaptive Hash Index
                            {{ info_tooltip("Change Buffer (formerly Insert Buffer) defers secondary index updates to reduce random I/O. Adaptive Hash Index builds in-memory hash indexes for frequently accessed data. High hash searches/s vs non-hash indicates AHI is effective. Can be disabled if causing contention.") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-midnight-400">Ibuf Size</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.insert_buffer.ibuf_size) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Ibuf Free List</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.insert_buffer.ibuf_free_list) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Ibuf Merges</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.insert_buffer.ibuf_merges) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Hash Table Buffers</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.insert_buffer.hash_table_buffers) }}</div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-6 text-sm">
                            <div>
                                <span class="text-midnight-400">Hash Searches/s:</span>
                                <span class="text-ocean-400 ml-2">{{ innodb_structured.insert_buffer.hash_searches_per_sec }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-400">Non-Hash Searches/s:</span>
                                <span class="text-ember-400 ml-2">{{ innodb_structured.insert_buffer.non_hash_searches_per_sec }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Transactions Section -->
                    {% if innodb_structured.transactions %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                            Transactions
                            {{ info_tooltip("Transaction ID counter increases with each new transaction. Purge Trx ID shows oldest transaction that purge can clean up. Large gap between these indicates old transactions blocking purge. History List Length grows when purge can't keep up.") }}
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-midnight-400">Transaction ID Counter</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.transactions.trx_id_counter) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Purge Trx ID</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.transactions.purge_trx_id) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">History List Length</div>
                                <div class="text-white font-mono">{{ "{:,}".format(innodb_structured.transactions.history_list_length) }}</div>
                            </div>
                            <div>
                                <div class="text-midnight-400">Active / Total</div>
                                <div class="text-white font-mono">{{ innodb_structured.transactions.active }} / {{ innodb_structured.transactions.total_transactions }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Background Thread -->
                    {% if innodb_structured.background_thread %}
                    <div class="bg-midnight-800/30 rounded-xl p-5 border border-midnight-700/50">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-midnight-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Background Thread
                            {{ info_tooltip("InnoDB master thread loop counters. Active loops handle pending operations (flushing, purging). Idle loops run when server is quiet. Shutdown loops occur during server shutdown. High active:idle ratio indicates sustained load.") }}
                        </h3>
                        <div class="flex gap-6 text-sm">
                            <div>
                                <span class="text-midnight-400">srv_active loops:</span>
                                <span class="text-white font-mono ml-2">{{ "{:,}".format(innodb_structured.background_thread.srv_active) }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-400">srv_shutdown loops:</span>
                                <span class="text-white font-mono ml-2">{{ "{:,}".format(innodb_structured.background_thread.srv_shutdown) }}</span>
                            </div>
                            <div>
                                <span class="text-midnight-400">srv_idle loops:</span>
                                <span class="text-white font-mono ml-2">{{ "{:,}".format(innodb_structured.background_thread.srv_idle) }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <!-- Fallback to raw if no structured data -->
                <div class="flex justify-end mb-3">
                    <button id="copy-innodb-btn" onclick="copyToClipboard('innodb-output', 'copy-innodb-btn')"
                            class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>Copy to Clipboard</span>
                    </button>
                </div>
                <div class="code-block rounded-xl p-4 max-h-[600px] overflow-auto">
                    <pre id="innodb-output" class="font-mono text-sm text-ocean-200 whitespace-pre-wrap">{{ innodb_output }}</pre>
                </div>
                {% endif %}
            </div>

            <!-- Global Status Tab -->
            <div x-show="currentTab === 'global'" x-cloak class="space-y-8"
                 x-data="{ chartsInitialized: false }"
                 x-effect="if (currentTab === 'global' && !chartsInitialized) { chartsInitialized = true; $nextTick(() => initGlobalStatusCharts()); }"
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Connections Chart -->
                    <div class="bg-midnight-800/50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-midnight-300 mb-4 flex items-center">
                            Thread Connections
                            {{ info_tooltip("Threads_connected: Active client connections. Threads_running: Actively executing queries (not sleeping). Max_used_connections: High watermark since startup. High running threads may indicate slow queries or insufficient resources.") }}
                        </h3>
                        <canvas id="connectionsChart" height="200"></canvas>
                    </div>
                    <!-- Queries Chart -->
                    <div class="bg-midnight-800/50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-midnight-300 mb-4 flex items-center">
                            Query Types
                            {{ info_tooltip("Cumulative count of each query type since server start. Com_select: SELECT queries. Com_insert/update/delete: Write operations. High update:select ratio indicates write-heavy workload.") }}
                        </h3>
                        <canvas id="queriesChart" height="200"></canvas>
                    </div>
                    <!-- InnoDB Rows Chart -->
                    <div class="bg-midnight-800/50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-midnight-300 mb-4 flex items-center">
                            InnoDB Row Operations
                            {{ info_tooltip("Innodb_rows_read/inserted/updated/deleted: Cumulative row-level operations. High reads typically indicate SELECT-heavy workload. Compare with Com_* counters to understand query efficiency.") }}
                        </h3>
                        <canvas id="innodbChart" height="200"></canvas>
                    </div>
                    <!-- Bytes Chart -->
                    <div class="bg-midnight-800/50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-midnight-300 mb-4 flex items-center">
                            Network Bytes
                            {{ info_tooltip("Bytes_sent: Data sent to clients (result sets). Bytes_received: Data from clients (queries). Large sent:received ratio is normal for read-heavy workloads. Sudden spikes may indicate large result sets or full table scans.") }}
                        </h3>
                        <canvas id="bytesChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Raw Values -->
                <script>
                    window.globalStatusData = {{ global_status | tojson | safe }};
                </script>
                <div class="bg-midnight-800/50 rounded-xl p-4" x-data="globalStatusTable()">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-midnight-300 flex items-center">
                            All Status Variables
                            {{ info_tooltip("Output from SHOW GLOBAL STATUS. These are runtime counters and metrics that reset on server restart. Use the search box to find specific variables like 'Innodb_', 'Threads_', 'Connections', etc.") }}
                        </h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-midnight-500" x-text="filtered.length + ' variables'"></span>
                            <input type="text" x-model="search" placeholder="Search variables..." 
                                   class="px-3 py-1.5 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500 w-48"
                            >
                        </div>
                    </div>
                    <div class="max-h-[400px] overflow-auto">
                        <table class="w-full text-sm table-fixed">
                            <thead class="sticky top-0 bg-midnight-800 z-10">
                                <tr>
                                    <th class="text-left py-2 px-3 text-midnight-400 font-medium w-1/3">Variable</th>
                                    <th class="text-left py-2 px-3 text-midnight-400 font-medium">Value</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-midnight-700/50">
                                <template x-for="item in filtered" :key="item.key">
                                    <tr class="hover:bg-midnight-700/30">
                                        <td class="py-2 px-3 font-mono text-ocean-300 text-xs break-all">
                                            <div class="flex items-center gap-1.5">
                                                <span x-text="item.key"></span>
                                                <template x-if="getVarDescription(item.key)">
                                                    <div class="relative group/tip flex-shrink-0">
                                                        <svg class="w-3.5 h-3.5 text-midnight-600 hover:text-ocean-400 cursor-help transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        <div class="absolute z-50 invisible group-hover/tip:visible opacity-0 group-hover/tip:opacity-100 transition-all duration-200 left-full ml-2 w-64 p-2.5 text-xs text-midnight-200 bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl shadow-black/30">
                                                            <div class="font-normal leading-relaxed" x-text="getVarDescription(item.key)"></div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="py-2 px-3 text-midnight-300">
                                            <!-- Short values -->
                                            <template x-if="!isLong(item.value)">
                                                <span class="font-mono text-xs" x-text="formatValue(item.value)"></span>
                                            </template>
                                            <!-- Long values (expandable) -->
                                            <template x-if="isLong(item.value)">
                                                <div>
                                                    <template x-if="expanded !== item.key">
                                                        <div class="flex items-center gap-2">
                                                            <span class="font-mono text-xs text-midnight-400 truncate max-w-[200px]" x-text="String(item.value).substring(0, 40) + '...'"></span>
                                                            <button @click="expanded = item.key" class="text-xs text-ocean-400 hover:text-ocean-300 whitespace-nowrap">
                                                                Show full
                                                            </button>
                                                        </div>
                                                    </template>
                                                    <template x-if="expanded === item.key">
                                                        <div>
                                                            <pre class="font-mono text-xs text-midnight-300 whitespace-pre-wrap break-all bg-midnight-900/50 p-2 rounded max-h-32 overflow-auto" x-text="item.value"></pre>
                                                            <button @click="expanded = null" class="text-xs text-ocean-400 hover:text-ocean-300 mt-1">
                                                                Collapse
                                                            </button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <script>
                const metrics = {{ key_metrics | safe }};
                const chartColors = {
                    ocean: 'rgba(14, 165, 233, 0.8)',
                    volt: 'rgba(132, 204, 22, 0.8)',
                    ember: 'rgba(249, 115, 22, 0.8)',
                    crimson: 'rgba(239, 68, 68, 0.8)',
                    midnight: 'rgba(100, 116, 139, 0.8)'
                };

                // Format large numbers (K, M, B)
                function formatNumber(val) {
                    if (val >= 1e12) return (val / 1e12).toFixed(2) + 'T';
                    if (val >= 1e9) return (val / 1e9).toFixed(2) + 'B';
                    if (val >= 1e6) return (val / 1e6).toFixed(2) + 'M';
                    if (val >= 1e3) return (val / 1e3).toFixed(2) + 'K';
                    return val.toString();
                }

                // Format bytes (KB, MB, GB, TB)
                function formatBytes(bytes) {
                    if (bytes >= 1e12) return (bytes / 1e12).toFixed(2) + ' TB';
                    if (bytes >= 1e9) return (bytes / 1e9).toFixed(2) + ' GB';
                    if (bytes >= 1e6) return (bytes / 1e6).toFixed(2) + ' MB';
                    if (bytes >= 1e3) return (bytes / 1e3).toFixed(2) + ' KB';
                    return bytes + ' B';
                }

                // Initialize charts (called when Global Status tab becomes visible)
                function initGlobalStatusCharts() {
                    // Prevent double initialization
                    if (window.globalChartsInitialized) return;
                    window.globalChartsInitialized = true;
                    
                    initChartsInternal();
                }
                
                function initChartsInternal() {
                // Connections Chart
                new Chart(document.getElementById('connectionsChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Connected', 'Running', 'Created', 'Cached'],
                        datasets: [{
                            data: [
                                metrics.connections?.current || 0,
                                metrics.connections?.running || 0,
                                metrics.connections?.created || 0,
                                metrics.connections?.cached || 0
                            ],
                            backgroundColor: [chartColors.ocean, chartColors.volt, chartColors.ember, chartColors.midnight]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => formatNumber(ctx.raw)
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { color: 'rgba(100, 116, 139, 0.2)' }, 
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: (val) => formatNumber(val)
                                } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });

                // Queries Chart
                new Chart(document.getElementById('queriesChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SELECT', 'INSERT', 'UPDATE', 'DELETE'],
                        datasets: [{
                            data: [
                                metrics.queries?.select || 0,
                                metrics.queries?.insert || 0,
                                metrics.queries?.update || 0,
                                metrics.queries?.delete || 0
                            ],
                            backgroundColor: [chartColors.ocean, chartColors.volt, chartColors.ember, chartColors.crimson]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { position: 'right', labels: { color: '#94a3b8' } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.label + ': ' + formatNumber(ctx.raw)
                                }
                            }
                        }
                    }
                });

                // InnoDB Chart
                new Chart(document.getElementById('innodbChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Read', 'Inserted', 'Updated', 'Deleted'],
                        datasets: [{
                            data: [
                                metrics.innodb?.rows_read || 0,
                                metrics.innodb?.rows_inserted || 0,
                                metrics.innodb?.rows_updated || 0,
                                metrics.innodb?.rows_deleted || 0
                            ],
                            backgroundColor: [chartColors.ocean, chartColors.volt, chartColors.ember, chartColors.crimson]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => formatNumber(ctx.raw) + ' rows'
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { color: 'rgba(100, 116, 139, 0.2)' }, 
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: (val) => formatNumber(val)
                                } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });

                // Bytes Chart
                new Chart(document.getElementById('bytesChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Received', 'Sent'],
                        datasets: [{
                            data: [
                                metrics.bytes?.received || 0,
                                metrics.bytes?.sent || 0
                            ],
                            backgroundColor: [chartColors.ocean, chartColors.volt]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => formatBytes(ctx.raw)
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { color: 'rgba(100, 116, 139, 0.2)' }, 
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: (val) => formatBytes(val)
                                } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
                }
                
                // Auto-init charts if Global Status is the default tab
                if ('{{ tab }}' === 'global') {
                    document.addEventListener('DOMContentLoaded', initGlobalStatusCharts);
                }

                // Global Status Table Component
                // MySQL Global Status Variable Descriptions
                const STATUS_VAR_DESCRIPTIONS = {
                    // Connections & Threads
                    'Aborted_clients': 'Connections closed due to client timeout or error without proper close',
                    'Aborted_connects': 'Failed connection attempts (bad password, unknown user, no privileges)',
                    'Connections': 'Total connection attempts (successful + failed) since server start',
                    'Max_used_connections': 'Peak concurrent connections since server start',
                    'Threads_cached': 'Threads in cache waiting to be reused',
                    'Threads_connected': 'Currently open connections',
                    'Threads_created': 'Threads created (high = increase thread_cache_size)',
                    'Threads_running': 'Threads actively executing queries (not sleeping)',
                    
                    // Queries & Commands
                    'Com_select': 'SELECT statements executed',
                    'Com_insert': 'INSERT statements executed',
                    'Com_update': 'UPDATE statements executed',
                    'Com_delete': 'DELETE statements executed',
                    'Com_replace': 'REPLACE statements executed',
                    'Com_commit': 'COMMIT statements executed',
                    'Com_rollback': 'ROLLBACK statements executed',
                    'Queries': 'Total queries (including stored procedures)',
                    'Questions': 'Client queries only (excludes stored procedures)',
                    'Slow_queries': 'Queries exceeding long_query_time threshold',
                    'Select_full_join': 'Joins without indexes (expensive - needs optimization)',
                    'Select_full_range_join': 'Joins using range search on reference table',
                    'Select_range': 'Joins using range on first table',
                    'Select_range_check': 'Joins without keys checking ranges per row',
                    'Select_scan': 'Full table scans on first table (may need indexing)',
                    'Sort_merge_passes': 'Merge passes for sorts (high = increase sort_buffer_size)',
                    'Sort_range': 'Sorts using ranges',
                    'Sort_rows': 'Total rows sorted',
                    'Sort_scan': 'Sorts using table scans',
                    
                    // InnoDB Buffer Pool
                    'Innodb_buffer_pool_read_requests': 'Logical reads from buffer pool',
                    'Innodb_buffer_pool_reads': 'Physical reads from disk (cache misses)',
                    'Innodb_buffer_pool_write_requests': 'Writes to buffer pool',
                    'Innodb_buffer_pool_pages_data': 'Pages containing data',
                    'Innodb_buffer_pool_pages_dirty': 'Modified pages not yet flushed',
                    'Innodb_buffer_pool_pages_flushed': 'Pages flushed to disk',
                    'Innodb_buffer_pool_pages_free': 'Free pages available',
                    'Innodb_buffer_pool_pages_misc': 'Pages for row locks, adaptive hash index, etc.',
                    'Innodb_buffer_pool_pages_total': 'Total buffer pool size in pages',
                    'Innodb_buffer_pool_wait_free': 'Waits for free pages (>0 = buffer pool too small)',
                    
                    // InnoDB Row Operations
                    'Innodb_rows_deleted': 'Rows deleted from InnoDB tables',
                    'Innodb_rows_inserted': 'Rows inserted into InnoDB tables',
                    'Innodb_rows_read': 'Rows read from InnoDB tables',
                    'Innodb_rows_updated': 'Rows updated in InnoDB tables',
                    
                    // InnoDB Locking
                    'Innodb_row_lock_current_waits': 'Row locks currently being waited for',
                    'Innodb_row_lock_time': 'Total time spent on row locks (ms)',
                    'Innodb_row_lock_time_avg': 'Average row lock wait time (ms)',
                    'Innodb_row_lock_time_max': 'Maximum row lock wait time (ms)',
                    'Innodb_row_lock_waits': 'Times a row lock had to wait',
                    
                    // InnoDB I/O
                    'Innodb_data_fsyncs': 'fsync() operations to disk',
                    'Innodb_data_pending_fsyncs': 'Pending fsync operations',
                    'Innodb_data_pending_reads': 'Pending read operations',
                    'Innodb_data_pending_writes': 'Pending write operations',
                    'Innodb_data_read': 'Total bytes read from disk',
                    'Innodb_data_reads': 'Total read operations',
                    'Innodb_data_writes': 'Total write operations',
                    'Innodb_data_written': 'Total bytes written to disk',
                    'Innodb_os_log_fsyncs': 'fsyncs to redo log',
                    'Innodb_os_log_pending_fsyncs': 'Pending redo log fsyncs',
                    'Innodb_os_log_pending_writes': 'Pending redo log writes',
                    'Innodb_os_log_written': 'Bytes written to redo log',
                    'Innodb_log_waits': 'Log buffer too small, had to wait (>0 = increase innodb_log_buffer_size)',
                    'Innodb_log_write_requests': 'Log write requests',
                    'Innodb_log_writes': 'Physical log writes',
                    
                    // InnoDB Transactions & Purge
                    'Innodb_history_list_length': 'Undo log pages waiting to be purged',
                    'Innodb_purge_trx_id': 'Oldest active transaction ID',
                    'Innodb_purge_undo_no': 'Current undo log record number being purged',
                    
                    // InnoDB Page Operations
                    'Innodb_pages_created': 'Pages created in buffer pool',
                    'Innodb_pages_read': 'Pages read from disk',
                    'Innodb_pages_written': 'Pages written to disk',
                    'Innodb_dblwr_pages_written': 'Pages written to doublewrite buffer',
                    'Innodb_dblwr_writes': 'Doublewrite operations',
                    
                    // Table & Handler
                    'Handler_read_first': 'Index first-entry reads (full index scans)',
                    'Handler_read_key': 'Row reads by key (good - using indexes)',
                    'Handler_read_last': 'Index last-entry reads',
                    'Handler_read_next': 'Next row reads in key order (range scans)',
                    'Handler_read_prev': 'Previous row reads in key order',
                    'Handler_read_rnd': 'Random row reads (expensive)',
                    'Handler_read_rnd_next': 'Next row reads in data order (table scans)',
                    'Handler_write': 'Row insert requests',
                    'Handler_update': 'Row update requests',
                    'Handler_delete': 'Row delete requests',
                    
                    // Table Cache
                    'Open_files': 'Currently open files',
                    'Open_tables': 'Currently open tables',
                    'Open_table_definitions': 'Cached table definitions',
                    'Opened_files': 'Files ever opened',
                    'Opened_tables': 'Tables ever opened (high = increase table_open_cache)',
                    'Opened_table_definitions': 'Table definitions ever opened',
                    'Table_locks_immediate': 'Table locks granted immediately',
                    'Table_locks_waited': 'Table locks that had to wait',
                    'Table_open_cache_hits': 'Table cache lookups that found an open table',
                    'Table_open_cache_misses': 'Table cache lookups that needed to open table',
                    'Table_open_cache_overflows': 'Tables removed from cache due to overflow',
                    
                    // Temp Tables
                    'Created_tmp_disk_tables': 'Temp tables on disk (increase tmp_table_size)',
                    'Created_tmp_files': 'Temp files created',
                    'Created_tmp_tables': 'Temp tables created (in-memory)',
                    
                    // Network
                    'Bytes_received': 'Total bytes received from clients',
                    'Bytes_sent': 'Total bytes sent to clients',
                    
                    // Binary Log
                    'Binlog_cache_disk_use': 'Transactions needing disk for binlog cache',
                    'Binlog_cache_use': 'Transactions using binlog cache',
                    'Binlog_stmt_cache_disk_use': 'Non-tx statements needing disk for cache',
                    'Binlog_stmt_cache_use': 'Non-tx statements using cache',
                    
                    // Keys (MyISAM)
                    'Key_blocks_not_flushed': 'Modified key blocks not yet flushed',
                    'Key_blocks_unused': 'Unused key cache blocks',
                    'Key_blocks_used': 'Used key cache blocks',
                    'Key_read_requests': 'Key block read requests from cache',
                    'Key_reads': 'Key block reads from disk (cache misses)',
                    'Key_write_requests': 'Key block write requests to cache',
                    'Key_writes': 'Key block writes to disk',
                    
                    // Query Cache (deprecated in MySQL 8.0)
                    'Qcache_free_blocks': 'Query cache free blocks',
                    'Qcache_free_memory': 'Query cache free memory',
                    'Qcache_hits': 'Query cache hits',
                    'Qcache_inserts': 'Queries added to cache',
                    'Qcache_lowmem_prunes': 'Queries removed due to low memory',
                    'Qcache_not_cached': 'Non-cached queries',
                    'Qcache_queries_in_cache': 'Queries currently cached',
                    'Qcache_total_blocks': 'Total query cache blocks',
                    
                    // SSL
                    'Ssl_accepts': 'SSL connection accepts',
                    'Ssl_client_connects': 'SSL client connection attempts',
                    'Ssl_connect_renegotiates': 'SSL connection renegotiations',
                    'Ssl_finished_accepts': 'Successful SSL accepts',
                    'Ssl_finished_connects': 'Successful SSL connects',
                    
                    // Replication
                    'Replica_open_temp_tables': 'Temp tables open by replication SQL thread',
                    'Replica_rows_last_search_algorithm_used': 'Last search algorithm for row-based replication',
                    
                    // Performance Schema
                    'Performance_schema_accounts_lost': 'Account rows not stored due to memory limit',
                    'Performance_schema_cond_classes_lost': 'Condition classes lost',
                    'Performance_schema_cond_instances_lost': 'Condition instances lost',
                    'Performance_schema_digest_lost': 'Digest rows lost',
                    'Performance_schema_file_classes_lost': 'File classes lost',
                    'Performance_schema_file_handles_lost': 'File handles lost',
                    'Performance_schema_file_instances_lost': 'File instances lost',
                    'Performance_schema_hosts_lost': 'Host rows lost',
                    'Performance_schema_index_stat_lost': 'Index stat rows lost',
                    'Performance_schema_locker_lost': 'Lock events lost',
                    'Performance_schema_memory_classes_lost': 'Memory classes lost',
                    'Performance_schema_metadata_lock_lost': 'Metadata lock rows lost',
                    'Performance_schema_mutex_classes_lost': 'Mutex classes lost',
                    'Performance_schema_mutex_instances_lost': 'Mutex instances lost',
                    'Performance_schema_nested_statement_lost': 'Nested statement events lost',
                    'Performance_schema_prepared_statements_lost': 'Prepared statements lost',
                    'Performance_schema_program_lost': 'Stored programs lost',
                    'Performance_schema_rwlock_classes_lost': 'RW-lock classes lost',
                    'Performance_schema_rwlock_instances_lost': 'RW-lock instances lost',
                    'Performance_schema_session_connect_attrs_lost': 'Session attributes lost',
                    'Performance_schema_socket_classes_lost': 'Socket classes lost',
                    'Performance_schema_socket_instances_lost': 'Socket instances lost',
                    'Performance_schema_stage_classes_lost': 'Stage classes lost',
                    'Performance_schema_statement_classes_lost': 'Statement classes lost',
                    'Performance_schema_table_handles_lost': 'Table handles lost',
                    'Performance_schema_table_instances_lost': 'Table instances lost',
                    'Performance_schema_table_lock_stat_lost': 'Table lock stat rows lost',
                    'Performance_schema_thread_classes_lost': 'Thread classes lost',
                    'Performance_schema_thread_instances_lost': 'Thread instances lost',
                    'Performance_schema_users_lost': 'User rows lost',
                    
                    // Server
                    'Uptime': 'Server uptime in seconds',
                    'Uptime_since_flush_status': 'Seconds since last FLUSH STATUS'
                };
                
                function globalStatusTable() {
                    return {
                        search: '',
                        expanded: null,
                        variables: Object.entries(window.globalStatusData || {}).map(([k, v]) => ({key: k, value: v})),
                        get filtered() {
                            if (!this.search) return this.variables;
                            const s = this.search.toLowerCase();
                            return this.variables.filter(v => v.key.toLowerCase().includes(s) || String(v.value).toLowerCase().includes(s));
                        },
                        formatValue(val) {
                            if (typeof val === 'number') {
                                if (val > 1000000000) return (val / 1000000000).toFixed(2) + 'B';
                                if (val > 1000000) return (val / 1000000).toFixed(2) + 'M';
                                if (val > 1000) return (val / 1000).toFixed(2) + 'K';
                                return val.toLocaleString();
                            }
                            return String(val);
                        },
                        isLong(val) {
                            return String(val).length > 50;
                        },
                        getVarDescription(varName) {
                            return STATUS_VAR_DESCRIPTIONS[varName] || null;
                        }
                    };
                }
            </script>

            <!-- Processlist Tab -->
            <script>
                window.processlistData = {{ processlist | tojson | safe }};
            </script>
            <div x-show="currentTab === 'processlist'" x-cloak class="space-y-6" x-data="processlistTable()">
                <!-- Processlist Info -->
                <div class="flex items-center gap-2 text-sm text-midnight-400">
                    <span>Active connections from SHOW FULL PROCESSLIST</span>
                    {{ info_tooltip("Shows all active MySQL connections. ID: Connection thread ID. User: MySQL user. Host: Client IP:port. DB: Current database. Command: Query/Sleep/Connect. Time: Seconds in current state. State: What thread is doing. Info: Current SQL (click to view full query).") }}
                </div>
                
                <!-- Filters (Client-side - no page reload) -->
                <div class="bg-midnight-800/50 rounded-xl p-4">
                    <button @click="showFilters = !showFilters" class="flex items-center gap-2 text-sm font-medium text-midnight-300 mb-4">
                        <svg class="w-4 h-4 transition-transform" :class="showFilters ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        Filters
                        <span x-show="userFilter || stateFilter || minTime || queryFilter" class="text-xs text-ocean-400">(active)</span>
                    </button>
                    <div x-show="showFilters" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs text-midnight-400 mb-1">User</label>
                            <input type="text" x-model="userFilter" 
                                   class="w-full px-3 py-2 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500"
                                   placeholder="Filter by user">
                        </div>
                        <div>
                            <label class="block text-xs text-midnight-400 mb-1">State</label>
                            <input type="text" x-model="stateFilter"
                                   class="w-full px-3 py-2 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500"
                                   placeholder="Filter by state">
                        </div>
                        <div>
                            <label class="block text-xs text-midnight-400 mb-1">Min Time (seconds)</label>
                            <input type="number" x-model="minTime"
                                   class="w-full px-3 py-2 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500"
                                   placeholder="e.g. 5">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-midnight-400 mb-1">Query (Info)</label>
                            <input type="text" x-model="queryFilter"
                                   class="w-full px-3 py-2 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500"
                                   placeholder="Filter by query content (e.g. SELECT, UPDATE, table_name)">
                        </div>
                        <div class="flex items-end gap-2">
                            <button @click="userFilter = ''; stateFilter = ''; minTime = ''; queryFilter = ''; currentPage = 1;" 
                                    class="px-4 py-2 rounded-lg bg-midnight-700 text-midnight-300 text-sm font-medium hover:bg-midnight-600 transition-colors">
                                Clear All
                            </button>
                            <span class="text-xs text-midnight-500 self-center" x-text="'Showing ' + filteredProcesses.length + ' of ' + processes.length"></span>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-midnight-800/50">
                            <tr>
                                <th @click="sort('id')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        ID
                                        <svg x-show="sortCol === 'id'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('user')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        User
                                        <svg x-show="sortCol === 'user'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('host')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        Host
                                        <svg x-show="sortCol === 'host'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('db')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        DB
                                        <svg x-show="sortCol === 'db'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('command')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        Command
                                        <svg x-show="sortCol === 'command'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('time')" class="text-right py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center justify-end gap-1">
                                        Time
                                        <svg x-show="sortCol === 'time'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th @click="sort('state')" class="text-left py-3 px-4 text-midnight-400 font-medium cursor-pointer hover:text-white transition-colors select-none">
                                    <span class="flex items-center gap-1">
                                        State
                                        <svg x-show="sortCol === 'state'" class="w-3 h-3" :class="sortAsc ? '' : 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </span>
                                </th>
                                <th class="text-left py-3 px-4 text-midnight-400 font-medium">Info</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-midnight-700/50">
                            <template x-if="sortedProcesses.length === 0">
                                <tr>
                                    <td colspan="8" class="py-8 text-center text-midnight-500">
                                        No processes found{% if user_filter or state_filter or min_time or query_filter %} matching filters{% endif %}
                                    </td>
                                </tr>
                            </template>
                            <template x-for="proc in paginatedProcesses" :key="proc.id">
                                <tr class="hover:bg-midnight-800/30">
                                    <td class="py-3 px-4 font-mono text-ocean-400" x-text="proc.id"></td>
                                    <td class="py-3 px-4 text-white" x-text="proc.user || '-'"></td>
                                    <td class="py-3 px-4 text-midnight-300 font-mono text-xs" x-text="proc.host || '-'"></td>
                                    <td class="py-3 px-4 text-midnight-300" x-text="proc.db || '-'"></td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-0.5 rounded text-xs font-medium"
                                              :class="proc.command === 'Query' ? 'bg-volt-500/20 text-volt-400' : 
                                                      proc.command === 'Sleep' ? 'bg-midnight-700 text-midnight-400' : 
                                                      'bg-ocean-500/20 text-ocean-400'"
                                              x-text="proc.command || '-'"></span>
                                    </td>
                                    <td class="py-3 px-4 text-right font-mono"
                                        :class="proc.time > 10 ? 'text-ember-400' : 
                                                proc.time > 5 ? 'text-yellow-400' : 'text-midnight-300'">
                                        <span x-text="(proc.time || 0) + 's'"></span>
                                    </td>
                                    <td class="py-3 px-4 text-midnight-300 text-xs" x-text="proc.state || '-'"></td>
                                    <td class="py-3 px-4 max-w-md">
                                        <template x-if="!proc.info">
                                            <span class="text-midnight-500">-</span>
                                        </template>
                                        <template x-if="proc.info">
                                            <div x-data="{ expanded: false }" class="relative">
                                                <!-- Collapsed view -->
                                                <div x-show="!expanded" class="flex items-center gap-2">
                                                    <code class="text-midnight-400 font-mono text-xs truncate max-w-xs cursor-pointer hover:text-ocean-400 transition-colors"
                                                          @click="expanded = true"
                                                          x-text="proc.info.length > 50 ? proc.info.substring(0, 50) + '...' : proc.info"></code>
                                                    <button x-show="proc.info.length > 50" @click="expanded = true" 
                                                            class="text-ocean-500 hover:text-ocean-400 text-xs flex-shrink-0">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                <!-- Expanded view with prettified SQL -->
                                                <div x-show="expanded" x-cloak 
                                                     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-midnight-950/80 backdrop-blur-sm"
                                                     @click.self="expanded = false"
                                                     @keydown.escape.window="expanded = false">
                                                    <div class="bg-midnight-800 border border-midnight-700 rounded-xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden"
                                                         @click.stop>
                                                        <!-- Header -->
                                                        <div class="flex items-center justify-between px-4 py-3 border-b border-midnight-700 bg-midnight-850">
                                                            <div class="flex items-center gap-3">
                                                                <span class="text-xs font-medium text-midnight-400 uppercase tracking-wider">SQL Query</span>
                                                                <span class="px-2 py-0.5 rounded text-xs bg-ocean-500/20 text-ocean-400" x-text="'ID: ' + proc.id"></span>
                                                                <span class="px-2 py-0.5 rounded text-xs bg-midnight-700 text-midnight-300" x-text="proc.user"></span>
                                                                <span x-show="proc.host" class="px-2 py-0.5 rounded text-xs bg-midnight-700 text-midnight-300 font-mono" x-text="proc.host"></span>
                                                                <span x-show="proc.db" class="px-2 py-0.5 rounded text-xs bg-volt-500/20 text-volt-400" x-text="proc.db"></span>
                                                            </div>
                                                            <div class="flex items-center gap-2" x-data="{ copied: false }">
                                                                <button @click="navigator.clipboard.writeText(proc.info); copied = true; setTimeout(() => copied = false, 2000)"
                                                                        class="p-1.5 rounded-lg transition-colors"
                                                                        :class="copied ? 'bg-volt-500/20 text-volt-400' : 'hover:bg-midnight-700 text-midnight-400 hover:text-white'"
                                                                        :title="copied ? 'Copied!' : 'Copy SQL'">
                                                                    <!-- Copy icon -->
                                                                    <svg x-show="!copied" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                                    </svg>
                                                                    <!-- Checkmark icon -->
                                                                    <svg x-show="copied" x-cloak class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                                                                    </svg>
                                                                </button>
                                                                <button @click="expanded = false" 
                                                                        class="p-1.5 rounded-lg hover:bg-midnight-700 text-midnight-400 hover:text-white transition-colors">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <!-- SQL Content -->
                                                        <div class="p-4 overflow-auto max-h-[60vh]">
                                                            <pre class="text-sm font-mono leading-relaxed whitespace-pre-wrap break-words" x-html="formatSQL(proc.info)"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-4 border-t border-midnight-700/50" x-show="sortedProcesses.length > 0">
                    <!-- Left: Info -->
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-midnight-500">
                            Showing <span class="text-midnight-300" x-text="startIndex"></span>-<span class="text-midnight-300" x-text="endIndex"></span> 
                            of <span class="text-midnight-300" x-text="sortedProcesses.length"></span> processes
                        </span>
                        <span class="text-midnight-600 text-sm">‚Ä¢ Click headers to sort</span>
                    </div>
                    
                    <!-- Right: Controls -->
                    <div class="flex items-center gap-4">
                        <!-- Per page selector -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-midnight-500">Per page:</span>
                            <select @change="setPerPage($event.target.value)" 
                                    class="px-2 py-1 rounded-lg bg-midnight-700/50 border border-midnight-600 text-white text-sm focus:border-ocean-500 focus:outline-none">
                                <option value="10" :selected="perPage === 10">10</option>
                                <option value="25" :selected="perPage === 25">25</option>
                                <option value="50" :selected="perPage === 50">50</option>
                                <option value="100" :selected="perPage === 100">100</option>
                            </select>
                        </div>
                        
                        <!-- Page navigation -->
                        <div class="flex items-center gap-1">
                            <!-- First page -->
                            <button @click="goToPage(1)" :disabled="currentPage === 1"
                                    class="p-1.5 rounded-lg transition-colors"
                                    :class="currentPage === 1 ? 'text-midnight-600 cursor-not-allowed' : 'text-midnight-400 hover:text-white hover:bg-midnight-700'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                                </svg>
                            </button>
                            <!-- Previous -->
                            <button @click="prevPage()" :disabled="currentPage === 1"
                                    class="p-1.5 rounded-lg transition-colors"
                                    :class="currentPage === 1 ? 'text-midnight-600 cursor-not-allowed' : 'text-midnight-400 hover:text-white hover:bg-midnight-700'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7 7" />
                                </svg>
                            </button>
                            
                            <!-- Page indicator -->
                            <span class="px-3 py-1 text-sm text-midnight-300">
                                Page <span class="text-white font-medium" x-text="currentPage"></span> of <span x-text="totalPages"></span>
                            </span>
                            
                            <!-- Next -->
                            <button @click="nextPage()" :disabled="currentPage === totalPages"
                                    class="p-1.5 rounded-lg transition-colors"
                                    :class="currentPage === totalPages ? 'text-midnight-600 cursor-not-allowed' : 'text-midnight-400 hover:text-white hover:bg-midnight-700'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                            <!-- Last page -->
                            <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages"
                                    class="p-1.5 rounded-lg transition-colors"
                                    :class="currentPage === totalPages ? 'text-midnight-600 cursor-not-allowed' : 'text-midnight-400 hover:text-white hover:bg-midnight-700'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Variables Tab -->
            <script>
                window.configVarsData = {{ config_vars | tojson | safe if config_vars else '{}' }};
                window.configAllowlist = {{ config_allowlist | tojson | safe if config_allowlist else '[]' }};
                window.configHealthData = {{ config_health | tojson | safe if config_health else '{}' }};
            </script>
            <div x-show="currentTab === 'config'" x-cloak class="space-y-6" x-data="configTable()">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span x-text="showAll ? 'All Config Variables' : 'Important Config (Effective Values)'"></span>
                        {{ info_tooltip("Server configuration from SHOW GLOBAL VARIABLES. 'Important' view shows ~30 key variables with health indicators (üü¢üü°üî¥) based on best practices. Health checks consider: buffer pool sizing, connection limits, I/O threads, durability settings, and cache efficiency.") }}
                    </h3>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-midnight-500">Source: SHOW GLOBAL VARIABLES</span>
                        <!-- Toggle Button -->
                        <button @click="showAll = !showAll"
                                class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                                :class="showAll ? 'bg-ocean-500/20 text-ocean-400' : 'bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700'">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                            <span x-text="showAll ? 'Show Important Only' : 'Show All Variables'"></span>
                        </button>
                    </div>
                </div>

                <!-- Search for All Variables mode -->
                <div x-show="showAll" x-cloak class="flex items-center gap-4">
                    <div class="relative flex-1 max-w-md">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-midnight-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input type="text" x-model="search" placeholder="Search variables..."
                               class="w-full pl-10 pr-4 py-2 bg-midnight-800/50 border border-midnight-700/50 rounded-lg text-sm text-white placeholder-midnight-500 focus:outline-none focus:border-ocean-500/50">
                    </div>
                </div>

                <template x-if="Object.keys(allVars).length > 0">
                    <div>
                        <div class="bg-midnight-800/30 rounded-xl border border-midnight-700/50 overflow-hidden">
                            <div class="max-h-[600px] overflow-auto">
                                <table class="w-full">
                                    <thead class="sticky top-0 bg-midnight-800">
                                        <tr class="border-b border-midnight-700/50">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase tracking-wider" style="width: 40%">Variable</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase tracking-wider" style="width: 45%">Value</th>
                                            <th x-show="!showAll" class="px-4 py-3 text-center text-xs font-semibold text-midnight-400 uppercase tracking-wider" style="width: 15%">Health</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-midnight-700/30">
                                        <template x-for="[varName, varVal] in filteredVars" :key="varName">
                                            <tr class="hover:bg-midnight-700/20 transition-colors">
                                                <td class="px-4 py-3 text-sm font-mono" :class="isImportant(varName) ? 'text-ocean-300' : 'text-midnight-300'">
                                                    <div class="flex items-center gap-1.5">
                                                    <span x-text="varName"></span>
                                                        <span x-show="isImportant(varName) && showAll" class="ml-1 text-xs text-ocean-500">‚òÖ</span>
                                                        <template x-if="getVarDescription(varName)">
                                                            <div class="relative group/tip flex-shrink-0">
                                                                <svg class="w-3.5 h-3.5 text-midnight-600 hover:text-ocean-400 cursor-help transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                </svg>
                                                                <div class="absolute z-50 invisible group-hover/tip:visible opacity-0 group-hover/tip:opacity-100 transition-all duration-200 left-full ml-2 w-72 p-2.5 text-xs text-midnight-200 bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl shadow-black/30">
                                                                    <div class="font-normal leading-relaxed" x-text="getVarDescription(varName)"></div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-white font-mono" x-html="formatValue(varName, varVal)"></td>
                                                <td x-show="!showAll" class="px-4 py-3 text-center">
                                                    <template x-if="getHealth(varName)">
                                                        <div class="relative inline-block" x-data="{ showTip: false }">
                                                            <span @mouseenter="showTip = true" @mouseleave="showTip = false" 
                                                                  class="cursor-help text-lg" x-html="getHealthEmoji(varName)"></span>
                                                            <div x-show="showTip" x-cloak
                                                                 class="absolute z-50 bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl whitespace-nowrap">
                                                                <span x-text="getHealthReason(varName)"></span>
                                                                <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-midnight-700"></div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <template x-if="!getHealth(varName)">
                                                        <span class="text-midnight-600">‚Äî</span>
                                                    </template>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="text-sm text-midnight-500 mt-3 flex items-center gap-4">
                            <span>Showing <span x-text="filteredVars.length"></span> of <span x-text="Object.keys(allVars).length"></span> configuration variables</span>
                            <span x-show="showAll" class="text-ocean-500">‚òÖ = important</span>
                            <span x-show="!showAll" class="flex items-center gap-3">
                                <span class="flex items-center gap-1"><span class="text-green-400">üü¢</span> Healthy</span>
                                <span class="flex items-center gap-1"><span class="text-yellow-400">üü°</span> Warning</span>
                                <span class="flex items-center gap-1"><span class="text-red-400">üî¥</span> Critical</span>
                            </span>
                        </div>
                    </div>
                </template>

                <template x-if="Object.keys(allVars).length === 0">
                    <div class="text-center py-12 text-midnight-400">
                        <svg class="w-12 h-12 mx-auto mb-4 text-midnight-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                        </svg>
                        <p>No configuration data available.</p>
                        <p class="text-sm mt-1">Run a new collection to get config variables.</p>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<!-- Processlist Table Component -->
<script>
    function processlistTable() {
        return {
            showFilters: true,
            sortCol: 'time',
            sortAsc: false,
            currentPage: 1,
            perPage: 25,
            // Client-side filters (no page reload!)
            userFilter: '',
            stateFilter: '',
            minTime: '',
            queryFilter: '',
            processes: window.processlistData || [],
            // Filter processes client-side
            get filteredProcesses() {
                return this.processes.filter(p => {
                    // User filter
                    if (this.userFilter && !String(p.user || '').toLowerCase().includes(this.userFilter.toLowerCase())) {
                        return false;
                    }
                    // State filter
                    if (this.stateFilter && !String(p.state || '').toLowerCase().includes(this.stateFilter.toLowerCase())) {
                        return false;
                    }
                    // Min time filter
                    if (this.minTime && (Number(p.time) || 0) < Number(this.minTime)) {
                        return false;
                    }
                    // Query/Info filter
                    if (this.queryFilter && !String(p.info || '').toLowerCase().includes(this.queryFilter.toLowerCase())) {
                        return false;
                    }
                    return true;
                });
            },
            get sortedProcesses() {
                return [...this.filteredProcesses].sort((a, b) => {
                    let aVal = a[this.sortCol];
                    let bVal = b[this.sortCol];
                    
                    // Handle nulls
                    if (aVal === null || aVal === undefined) aVal = '';
                    if (bVal === null || bVal === undefined) bVal = '';
                    
                    // Numeric sort for id and time
                    if (this.sortCol === 'id' || this.sortCol === 'time') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return this.sortAsc ? -1 : 1;
                    if (aVal > bVal) return this.sortAsc ? 1 : -1;
                    return 0;
                });
            },
            get totalPages() {
                return Math.ceil(this.sortedProcesses.length / this.perPage) || 1;
            },
            get paginatedProcesses() {
                const start = (this.currentPage - 1) * this.perPage;
                return this.sortedProcesses.slice(start, start + this.perPage);
            },
            get startIndex() {
                if (this.sortedProcesses.length === 0) return 0;
                return (this.currentPage - 1) * this.perPage + 1;
            },
            get endIndex() {
                return Math.min(this.currentPage * this.perPage, this.sortedProcesses.length);
            },
            sort(col) {
                if (this.sortCol === col) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortCol = col;
                    this.sortAsc = true;
                }
                this.currentPage = 1; // Reset to first page on sort
            },
            nextPage() {
                if (this.currentPage < this.totalPages) this.currentPage++;
            },
            prevPage() {
                if (this.currentPage > 1) this.currentPage--;
            },
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) this.currentPage = page;
            },
            setPerPage(val) {
                this.perPage = parseInt(val);
                this.currentPage = 1;
            }
        };
    }

    // SQL Formatter with syntax highlighting (token-based to avoid regex conflicts)
    function formatSQL(sql) {
        if (!sql) return '';
        
        // Convert literal \n, \r, \t to actual whitespace
        sql = sql.replace(/\\n/g, '\n').replace(/\\r/g, '\r').replace(/\\t/g, '\t');
        
        // Escape HTML
        const escape = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Keywords that should have line breaks before them
        const lineBreakKeywords = new Set(['FROM', 'WHERE', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'OUTER', 
                                           'ORDER', 'GROUP', 'HAVING', 'LIMIT', 'SET', 'VALUES', 'AND', 'OR', 'ON']);
        
        // All SQL keywords
        const keywords = new Set(['SELECT', 'FROM', 'WHERE', 'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 
                                  'DELETE', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'OUTER', 'CROSS', 'NATURAL',
                                  'ON', 'AND', 'OR', 'NOT', 'IN', 'LIKE', 'BETWEEN', 'IS', 'NULL',
                                  'ORDER', 'BY', 'GROUP', 'HAVING', 'LIMIT', 'OFFSET', 'UNION', 'ALL',
                                  'CREATE', 'ALTER', 'DROP', 'TABLE', 'INDEX', 'VIEW', 'DATABASE',
                                  'AS', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MAX', 'MIN', 'CASE', 'WHEN', 
                                  'THEN', 'ELSE', 'END', 'TRUE', 'FALSE', 'DEFAULT', 'PRIMARY', 'KEY',
                                  'FORCE', 'USE', 'IGNORE', 'ASC', 'DESC', 'EXISTS', 'FOR', 'LOCK',
                                  'COMMIT', 'ROLLBACK', 'START', 'TRANSACTION', 'BEGIN']);
        
        // Functions
        const functions = new Set(['NOW', 'CURDATE', 'DATE', 'TIME', 'TIMESTAMP', 'YEAR', 'MONTH', 'DAY',
                                   'CONCAT', 'SUBSTRING', 'LENGTH', 'UPPER', 'LOWER', 'TRIM', 'REPLACE',
                                   'COALESCE', 'IFNULL', 'IF', 'CAST', 'CONVERT', 'DATE_FORMAT', 'UNIX_TIMESTAMP']);
        
        let result = [];
        let i = 0;
        
        while (i < sql.length) {
            // String literal (single quote)
            if (sql[i] === "'") {
                let end = i + 1;
                while (end < sql.length && sql[end] !== "'") end++;
                const str = sql.substring(i, end + 1);
                result.push(`<span class="text-volt-400">${escape(str)}</span>`);
                i = end + 1;
                continue;
            }
            
            // Backtick identifier
            if (sql[i] === '`') {
                let end = i + 1;
                while (end < sql.length && sql[end] !== '`') end++;
                const str = sql.substring(i, end + 1);
                result.push(`<span class="text-ocean-400">${escape(str)}</span>`);
                i = end + 1;
                continue;
            }
            
            // Number
            if (/\d/.test(sql[i])) {
                let end = i;
                while (end < sql.length && /[\d.]/.test(sql[end])) end++;
                const num = sql.substring(i, end);
                result.push(`<span class="text-ember-400">${escape(num)}</span>`);
                i = end;
                continue;
            }
            
            // Word (keyword, function, or identifier)
            if (/[a-zA-Z_]/.test(sql[i])) {
                let end = i;
                while (end < sql.length && /[a-zA-Z0-9_]/.test(sql[end])) end++;
                const word = sql.substring(i, end);
                const upper = word.toUpperCase();
                
                // Check if line break needed
                let prefix = '';
                if (lineBreakKeywords.has(upper) && result.length > 0) {
                    prefix = '\n';
                }
                
                if (keywords.has(upper)) {
                    result.push(`${prefix}<span class="text-violet-400 font-semibold">${escape(word)}</span>`);
                } else if (functions.has(upper)) {
                    result.push(`${prefix}<span class="text-cyan-400">${escape(word)}</span>`);
                } else {
                    result.push(`${prefix}<span class="text-white">${escape(word)}</span>`);
                }
                i = end;
                continue;
            }
            
            // Whitespace - normalize multiple spaces/newlines
            if (/\s/.test(sql[i])) {
                let end = i;
                while (end < sql.length && /\s/.test(sql[end])) end++;
                result.push(' ');
                i = end;
                continue;
            }
            
            // Comments (/* ... */)
            if (sql[i] === '/' && sql[i+1] === '*') {
                let end = i + 2;
                while (end < sql.length - 1 && !(sql[end] === '*' && sql[end+1] === '/')) end++;
                const comment = sql.substring(i, end + 2);
                result.push(`<span class="text-midnight-500 italic">${escape(comment)}</span>`);
                i = end + 2;
                continue;
            }
            
            // Other characters (operators, punctuation)
            result.push(`<span class="text-midnight-300">${escape(sql[i])}</span>`);
            i++;
        }
        
        return result.join('');
    }
</script>

<!-- Config Table Component -->
<script>
    // MySQL Config Variable Descriptions
    const CONFIG_VAR_DESCRIPTIONS = {
        // InnoDB Buffer Pool
        'innodb_buffer_pool_size': 'Main memory area for InnoDB data and indexes. Set to 70-80% of available RAM for dedicated servers.',
        'innodb_buffer_pool_instances': 'Number of buffer pool regions. Use 8+ for buffer pools >1GB to reduce contention.',
        'innodb_buffer_pool_chunk_size': 'Chunk size for buffer pool resizing. Buffer pool size should be multiple of chunk_size √ó instances.',
        
        // InnoDB Redo Log
        'innodb_log_file_size': 'Size of each redo log file. Larger = better write performance but longer crash recovery.',
        'innodb_log_files_in_group': 'Number of redo log files (default 2). Total redo log = size √ó count.',
        'innodb_log_buffer_size': 'Buffer for redo log writes. Increase if Innodb_log_waits > 0.',
        'innodb_flush_log_at_trx_commit': 'Durability: 1=ACID compliant (safest), 2=flush/sec (faster), 0=no flush (fastest, risky).',
        
        // InnoDB I/O
        'innodb_read_io_threads': 'Background threads for read operations. Increase for SSD or high IOPS storage.',
        'innodb_write_io_threads': 'Background threads for write operations. Increase for SSD or high IOPS storage.',
        'innodb_io_capacity': 'IOPS limit for background tasks (flushing, merging). Set based on storage capability.',
        'innodb_io_capacity_max': 'Maximum IOPS for flushing under pressure. Typically 2√ó innodb_io_capacity.',
        'innodb_flush_method': 'How InnoDB flushes data. O_DIRECT avoids double buffering on Linux.',
        
        // InnoDB Transactions
        'innodb_lock_wait_timeout': 'Seconds to wait for row lock before timeout. Default 50s.',
        'innodb_rollback_on_timeout': 'Whether to roll back entire transaction (ON) or just last statement (OFF) on lock timeout.',
        'innodb_deadlock_detect': 'Enable deadlock detection. Disable only in specific high-contention scenarios.',
        
        // InnoDB Change Buffer
        'innodb_change_buffering': 'What changes to buffer: all, none, inserts, deletes, changes, purges.',
        'innodb_change_buffer_max_size': 'Max change buffer size as % of buffer pool (default 25%).',
        
        // InnoDB Adaptive Hash
        'innodb_adaptive_hash_index': 'Build hash indexes for frequently accessed pages. Can cause contention - consider disabling.',
        'innodb_adaptive_hash_index_parts': 'Number of AHI partitions to reduce contention (MySQL 5.7+).',
        
        // InnoDB Misc
        'innodb_file_per_table': 'Store each table in its own .ibd file (ON recommended).',
        'innodb_sync_array_size': 'Number of sync array instances for thread concurrency.',
        'innodb_autoinc_lock_mode': '0=traditional, 1=consecutive (safe for replication), 2=interleaved (fastest).',
        'innodb_stats_persistent': 'Store index statistics on disk (ON) or recalculate on restart (OFF).',
        'innodb_stats_auto_recalc': 'Automatically recalculate statistics when table changes significantly.',
        'innodb_strict_mode': 'Enforce strict mode for CREATE TABLE syntax validation.',
        'innodb_print_all_deadlocks': 'Log all deadlocks to error log (useful for debugging).',
        
        // Connections
        'max_connections': 'Maximum simultaneous connections. Set based on expected load + buffer.',
        'max_connect_errors': 'Block host after this many interrupted connections. Use FLUSH HOSTS to reset.',
        'thread_cache_size': 'Threads to cache for reuse. Reduces thread creation overhead.',
        'thread_stack': 'Stack size per thread. Increase if getting "thread stack" errors.',
        'wait_timeout': 'Seconds before closing idle non-interactive connection.',
        'interactive_timeout': 'Seconds before closing idle interactive connection.',
        'connect_timeout': 'Seconds to wait for connection packet from client.',
        
        // Query Execution
        'max_allowed_packet': 'Maximum packet size for queries/results. Increase for large BLOBs.',
        'tmp_table_size': 'Max size for in-memory temp tables. Larger reduces disk temp tables.',
        'max_heap_table_size': 'Max size for MEMORY tables. Works with tmp_table_size (min of both applies).',
        'sort_buffer_size': 'Buffer per-connection for sorts. Increase if Sort_merge_passes is high.',
        'join_buffer_size': 'Buffer for joins without indexes. Used per join in query.',
        'read_buffer_size': 'Buffer for sequential table scans.',
        'read_rnd_buffer_size': 'Buffer for reading rows in sorted order (after sorting).',
        
        // Table Cache
        'table_open_cache': 'Number of open table descriptors to cache. Increase if Opened_tables is high.',
        'table_definition_cache': 'Number of table definitions to cache.',
        'table_open_cache_instances': 'Number of table cache instances to reduce contention.',
        'open_files_limit': 'OS file descriptor limit. Should be > table_open_cache √ó 2.',
        
        // Binary Logging
        'log_bin': 'Binary log file name prefix (enables binary logging).',
        'binlog_format': 'ROW (safest), STATEMENT (compact), MIXED (automatic). ROW recommended.',
        'sync_binlog': '1=sync every commit (safe), 0=OS handles (fast but risky).',
        'binlog_cache_size': 'Cache for binary log during transaction.',
        'max_binlog_size': 'Max size before rotating to new binlog file.',
        'expire_logs_days': 'Automatically purge binlogs older than this (0=never).',
        'binlog_expire_logs_seconds': 'Seconds before purging binlogs (MySQL 8.0+).',
        'binlog_group_commit_sync_delay': 'Microseconds to delay sync for group commit. Improves throughput.',
        'binlog_group_commit_sync_no_delay_count': 'Transactions to accumulate before triggering sync.',
        
        // Replication
        'server_id': 'Unique server identifier for replication (must be unique in topology).',
        'gtid_mode': 'GTID replication: OFF, OFF_PERMISSIVE, ON_PERMISSIVE, ON.',
        'enforce_gtid_consistency': 'Enforce statements compatible with GTID replication.',
        'slave_parallel_workers': 'Number of parallel replication threads (0=single-threaded).',
        'slave_preserve_commit_order': 'Maintain commit order in parallel replication.',
        'replica_parallel_workers': 'MySQL 8.0+ name for slave_parallel_workers.',
        'replica_preserve_commit_order': 'MySQL 8.0+ name for slave_preserve_commit_order.',
        'read_only': 'Prevent non-SUPER users from writing (useful for replicas).',
        'super_read_only': 'Prevent even SUPER users from writing.',
        
        // Query Cache (deprecated MySQL 8.0)
        'query_cache_type': 'Query cache: 0=OFF, 1=ON, 2=DEMAND. Deprecated in MySQL 8.0.',
        'query_cache_size': 'Memory for query cache. Set to 0 to disable completely.',
        
        // Performance Schema
        'performance_schema': 'Enable Performance Schema instrumentation.',
        'performance_schema_events_statements_history_size': 'Statement history per thread.',
        'performance_schema_events_stages_history_size': 'Stage history per thread.',
        'performance_schema_max_table_instances': 'Maximum table objects instrumented.',
        
        // Logging
        'slow_query_log': 'Enable slow query logging.',
        'long_query_time': 'Queries longer than this (seconds) are logged as slow.',
        'log_queries_not_using_indexes': 'Log queries that don\'t use indexes.',
        'general_log': 'Log all queries (use only for debugging - high overhead).',
        'log_error': 'Error log file path.',
        'log_output': 'Where to send logs: FILE, TABLE, or NONE.',
        
        // Character Set
        'character_set_server': 'Default server character set.',
        'collation_server': 'Default server collation.',
        
        // Prepared Statements
        'max_prepared_stmt_count': 'Maximum prepared statements server-wide.',
        
        // MyISAM
        'key_buffer_size': 'Buffer for MyISAM index blocks. Less important if using only InnoDB.',
        'myisam_sort_buffer_size': 'Buffer for MyISAM index sorting during REPAIR/CREATE INDEX.',
        
        // Misc
        'sql_mode': 'Server SQL mode (affects SQL syntax strictness).',
        'lower_case_table_names': '0=case-sensitive, 1=stored lowercase, 2=stored as-is compared lowercase.',
        'event_scheduler': 'Enable MySQL Event Scheduler.',
        'default_storage_engine': 'Default engine for new tables (InnoDB recommended).'
    };
    
    function configTable() {
        const byteVars = ['innodb_buffer_pool_size', 'innodb_log_file_size', 'innodb_log_buffer_size', 'tmp_table_size', 'max_heap_table_size'];
        
        return {
            showAll: false,
            search: '',
            allVars: window.configVarsData || {},
            allowlist: window.configAllowlist || [],
            healthData: window.configHealthData || {},
            
            isImportant(varName) {
                return this.allowlist.includes(varName);
            },
            
            getHealth(varName) {
                const health = this.healthData[varName];
                return health ? health.health : null;
            },
            
            getHealthReason(varName) {
                const health = this.healthData[varName];
                return health ? health.reason : '';
            },
            
            getHealthEmoji(varName) {
                const health = this.getHealth(varName);
                if (health === 'healthy') return 'üü¢';
                if (health === 'warning') return 'üü°';
                if (health === 'critical') return 'üî¥';
                return '';
            },
            
            getHealthIcon(varName) {
                // Legacy function (kept for compatibility)
                return this.getHealthEmoji(varName);
            },
            
            get filteredVars() {
                let entries = Object.entries(this.allVars);
                
                // Filter to important only if not showing all
                if (!this.showAll) {
                    entries = entries.filter(([name]) => this.isImportant(name));
                }
                
                // Apply search filter
                if (this.search && this.showAll) {
                    const s = this.search.toLowerCase();
                    entries = entries.filter(([name, val]) => 
                        name.toLowerCase().includes(s) || 
                        String(val).toLowerCase().includes(s)
                    );
                }
                
                // Sort alphabetically
                return entries.sort((a, b) => a[0].localeCompare(b[0]));
            },
            
            formatValue(varName, val) {
                // Try to parse as number
                const numVal = parseInt(val, 10);
                
                // Byte formatting for specific variables
                if (!isNaN(numVal) && numVal > 0 && byteVars.includes(varName)) {
                    if (numVal >= 1073741824) {
                        return `${(numVal / 1073741824).toFixed(2)} GB <span class="text-midnight-500 text-xs ml-2">(${numVal.toLocaleString()})</span>`;
                    } else if (numVal >= 1048576) {
                        return `${(numVal / 1048576).toFixed(2)} MB <span class="text-midnight-500 text-xs ml-2">(${numVal.toLocaleString()})</span>`;
                    } else if (numVal >= 1024) {
                        return `${(numVal / 1024).toFixed(2)} KB <span class="text-midnight-500 text-xs ml-2">(${numVal.toLocaleString()})</span>`;
                    }
                }
                
                // Number formatting
                if (!isNaN(numVal) && numVal > 0 && String(numVal) === val) {
                    return numVal.toLocaleString();
                }
                
                // ON/OFF badges
                if (val === 'ON') {
                    return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/20 text-green-400">ON</span>';
                }
                if (val === 'OFF') {
                    return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-midnight-600/50 text-midnight-400">OFF</span>';
                }
                
                // Truncate very long values
                if (String(val).length > 100) {
                    return `<span title="${val.replace(/"/g, '&quot;')}">${val.substring(0, 100)}...</span>`;
                }
                
                return val;
            },
            
            getVarDescription(varName) {
                return CONFIG_VAR_DESCRIPTIONS[varName] || null;
            }
        };
    }
</script>
{% endblock %}

